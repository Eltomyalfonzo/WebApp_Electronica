<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FRA Monitor - UTN FRSF</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Roboto', sans-serif;
      background: #f5f7fa;
      color: #2c3e50;
      min-height: 100vh;
    }

    .navbar {
      background: #1a2332;
      padding: 1rem 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      border-bottom: 3px solid #2c5aa0;
    }

    .navbar-brand {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .logo-utn {
      width: 50px;
      height: 50px;
      background: white;
      border-radius: 4px;
      padding: 4px;
    }

    .navbar h1 {
      font-size: 1.5rem;
      font-weight: 500;
      color: white;
      letter-spacing: 0.5px;
    }

    .navbar-actions button {
      background: #2c5aa0;
      color: white;
      border: none;
      padding: 0.6rem 1.2rem;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
      font-size: 0.9rem;
      transition: all 0.3s ease;
    }

    .navbar-actions button:hover {
      background: #3d6fb8;
      box-shadow: 0 2px 8px rgba(44, 90, 160, 0.3);
    }

    .sidebar {
      position: fixed;
      left: 0;
      top: 76px;
      width: 250px;
      height: calc(100vh - 76px);
      background: white;
      border-right: 1px solid #e1e8ed;
      padding: 1.5rem 0;
      overflow-y: auto;
      box-shadow: 2px 0 8px rgba(0, 0, 0, 0.05);
    }

    .sidebar h3 {
      padding: 0 1.5rem;
      color: #1a2332;
      font-size: 0.9rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 1rem;
    }

    .menu-item {
      padding: 0.9rem 1.5rem;
      cursor: pointer;
      transition: all 0.2s ease;
      color: #5a6c7d;
      font-weight: 400;
      border-left: 3px solid transparent;
    }

    .menu-item:hover {
      background: #f8f9fa;
      color: #2c5aa0;
      border-left-color: #2c5aa0;
    }

    .menu-item.active {
      background: #e8f0f8;
      color: #2c5aa0;
      border-left-color: #2c5aa0;
      font-weight: 500;
    }

    .main-content {
      margin-left: 250px;
      padding: 2rem;
      min-height: calc(100vh - 76px);
    }

    .content-section {
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .content-section.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .card {
      background: white;
      border-radius: 8px;
      padding: 1.5rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      margin-bottom: 1.5rem;
    }

    .card h2 {
      color: #1a2332;
      font-size: 1.3rem;
      font-weight: 500;
      margin-bottom: 1rem;
      padding-bottom: 0.8rem;
      border-bottom: 2px solid #e1e8ed;
    }

    .card p {
      line-height: 1.6;
      color: #5a6c7d;
      margin-bottom: 0.8rem;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
      margin-top: 1.5rem;
    }

    .info-item {
      background: #f8f9fa;
      padding: 1rem;
      border-radius: 6px;
      border-left: 3px solid #2c5aa0;
    }

    .info-item h4 {
      color: #1a2332;
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .info-item p {
      color: #5a6c7d;
      font-size: 0.9rem;
      margin: 0;
    }

    .charts-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .chart-container {
      background: white;
      border-radius: 8px;
      padding: 1.5rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .chart-container h3 {
      color: #1a2332;
      font-size: 1.1rem;
      font-weight: 500;
      margin-bottom: 1rem;
    }

    .chart-container canvas {
      width: 100% !important;
      height: 300px !important;
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-group label {
      display: block;
      color: #1a2332;
      font-weight: 500;
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
    }

    .form-control {
      width: 100%;
      padding: 0.7rem;
      border: 1px solid #d1d9e0;
      border-radius: 4px;
      font-family: 'Roboto', sans-serif;
      font-size: 0.9rem;
      transition: border-color 0.2s ease;
    }

    .form-control:focus {
      outline: none;
      border-color: #2c5aa0;
      box-shadow: 0 0 0 3px rgba(44, 90, 160, 0.1);
    }

    .form-inline {
      display: flex;
      gap: 1rem;
      align-items: flex-end;
      flex-wrap: wrap;
    }

    .form-inline .form-group {
      flex: 1;
      min-width: 200px;
      margin-bottom: 0;
    }

    .btn {
      background: #2c5aa0;
      color: white;
      border: none;
      padding: 0.7rem 1.5rem;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
      font-size: 0.9rem;
      transition: all 0.3s ease;
    }

    .btn:hover {
      background: #3d6fb8;
      box-shadow: 0 2px 8px rgba(44, 90, 160, 0.3);
    }

    .btn-secondary {
      background: #6c757d;
    }

    .btn-secondary:hover {
      background: #5a6268;
    }

    .btn-danger {
      background: #dc3545;
    }

    .btn-danger:hover {
      background: #c82333;
    }

    .console-box {
      background: #1a2332;
      border: 1px solid #2c3e50;
      border-radius: 4px;
      padding: 1rem;
      height: 150px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 0.85rem;
      color: #a8b8cc;
      line-height: 1.5;
    }

    /* NUEVOS ESTILOS PARA OSCILOSCOPIO MEJORADO */
    .info-bar {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      padding: 0.8rem;
      background: #1a2332;
      color: white;
      border-radius: 4px;
      margin-bottom: 1rem;
      font-size: 0.85rem;
      gap: 1rem;
    }

    .info-bar-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .info-label {
      color: #8899a6;
    }

    .info-value {
      font-weight: 600;
      color: #2c5aa0;
      background: white;
      padding: 0.2rem 0.5rem;
      border-radius: 3px;
    }

    .channel-controls {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .channel-panel {
      background: #f8f9fa;
      padding: 1rem;
      border-radius: 6px;
      border-left: 4px solid #2c5aa0;
    }

    .channel-panel.ch2 {
      border-left-color: #6c757d;
    }

    .channel-panel h3 {
      color: #1a2332;
      font-size: 1rem;
      margin-bottom: 0.8rem;
    }

    .channel-buttons {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.8rem;
    }

    .channel-buttons .btn {
      flex: 1;
      padding: 0.6rem 1rem;
      font-size: 0.85rem;
    }

    .control-group {
      margin-bottom: 0.8rem;
    }

    .control-group label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: #1a2332;
      font-weight: 500;
      font-size: 0.85rem;
      margin-bottom: 0.4rem;
    }

    .scale-value {
      color: #2c5aa0;
      font-weight: 600;
      font-size: 0.9rem;
    }

    .control-group select,
    .control-group input[type="range"],
    .control-group input[type="number"] {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid #d1d9e0;
      border-radius: 4px;
      font-family: 'Roboto', sans-serif;
      font-size: 0.85rem;
    }

    .control-group input[type="range"] {
      cursor: pointer;
      padding: 0;
    }

    .oscilloscope-controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
      background: #f8f9fa;
      padding: 1rem;
      border-radius: 6px;
    }

    .trigger-controls {
      background: #f8f9fa;
      padding: 1rem;
      border-radius: 6px;
      margin-bottom: 1.5rem;
      border-left: 4px solid #ffc107;
    }

    .trigger-controls h3 {
      color: #1a2332;
      font-size: 1rem;
      margin-bottom: 0.8rem;
    }

    .adc-controls {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .adc-trigger-controls {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
      align-items: flex-end;
    }

    .adc-trigger-controls .form-group {
      margin-bottom: 0;
    }

    .full-width-chart {
      grid-column: 1 / -1;
    }

    .download-options {
      display: flex;
      gap: 1rem;
      margin-top: 1rem;
    }

    /* NUEVOS ESTILOS PARA MULTI-MEDICI√ìN */
    .measurement-controls {
      background: #f8f9fa;
      padding: 1rem;
      border-radius: 6px;
      margin-bottom: 1rem;
      border-left: 4px solid #2c5aa0;
    }

    .measurement-controls .form-inline {
      margin-top: 0.5rem;
    }

    .measurement-list {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 1rem;
      padding: 0.8rem;
      background: #f8f9fa;
      border-radius: 6px;
      min-height: 45px;
      align-items: center;
    }

    .measurement-tag {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.4rem 0.8rem;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 500;
      color: white;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .measurement-tag .color-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      border: 2px solid white;
    }

    .empty-measurements {
      color: #8899a6;
      font-size: 0.85rem;
      font-style: italic;
    }

    @media (max-width: 1024px) {
      .sidebar {
        transform: translateX(-100%);
        z-index: 1000;
      }

      .sidebar.mobile-open {
        transform: translateX(0);
      }

      .main-content {
        margin-left: 0;
      }

      .charts-grid {
        grid-template-columns: 1fr;
      }

      .adc-controls {
        grid-template-columns: 1fr 1fr;
      }

      .channel-controls {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 768px) {
      .navbar {
        flex-direction: column;
        gap: 1rem;
      }

      .form-inline {
        flex-direction: column;
      }

      .form-inline .form-group {
        width: 100%;
      }

      .adc-controls {
        grid-template-columns: 1fr;
      }

      .info-bar {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>

<div class="navbar">
  <div class="navbar-brand">
    <svg class="logo-utn" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
      <rect width="100" height="100" fill="#1a2332"/>
      <text x="50" y="55" font-family="Arial, sans-serif" font-size="40" font-weight="bold" fill="white" text-anchor="middle">UTN</text>
      <text x="50" y="75" font-family="Arial, sans-serif" font-size="12" fill="#2c5aa0" text-anchor="middle">FRSF</text>
    </svg>
    <div>
      <h1>FRA Monitor</h1>
      <p style="font-size: 0.8rem; color: #8899a6; margin: 0;">Analizador de Respuesta en Frecuencia</p>
    </div>
  </div>
  <div class="navbar-actions">
    <button id="downloadAllBtn">Descargar Gr√°ficos</button>
  </div>
</div>

<div class="sidebar">
  <h3>Herramientas</h3>
  <div class="menu-item active" data-section="inicio">Inicio</div>
  <div class="menu-item" data-section="bode">Diagrama de Bode</div>
  <div class="menu-item" data-section="nyquist">Diagrama de Nyquist</div>
  <div class="menu-item" data-section="osciloscopio">Osciloscopio</div>
  <div class="menu-item" data-section="conexion">Conexi√≥n y Control</div>
</div>

<div class="main-content">
  <!-- SECCI√ìN INICIO -->
  <div class="content-section active" id="inicio">
    <div class="card">
      <h2>Bienvenido al FRA Monitor</h2>
      <p>Sistema de monitoreo y an√°lisis de respuesta en frecuencia para dispositivos embebidos, desarrollado en la <strong>Universidad Tecnol√≥gica Nacional - Facultad Regional San Francisco</strong>.</p>
      
      <div class="info-grid">
        <div class="info-item">
          <h4>An√°lisis de Bode</h4>
          <p>Visualiza la magnitud y fase de la respuesta en frecuencia del sistema bajo prueba.</p>
        </div>
        <div class="info-item">
          <h4>Diagrama de Nyquist</h4>
          <p>Representa la respuesta en frecuencia en el plano complejo para an√°lisis de estabilidad.</p>
        </div>
        <div class="info-item">
          <h4>Osciloscopio Digital</h4>
          <p>Captura y visualiza se√±ales anal√≥gicas de dos canales en tiempo real con trigger configurable.</p>
        </div>
        <div class="info-item">
          <h4>Conexi√≥n MQTT</h4>
          <p>Comunicaci√≥n en tiempo real con dispositivos ESP32 a trav√©s de protocolo MQTT.</p>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Descripci√≥n del Proyecto</h2>
      <p>El FRA Monitor es una herramienta de an√°lisis de sistemas de control y circuitos electr√≥nicos que permite caracterizar la respuesta en frecuencia de forma remota. Utiliza tecnolog√≠a web moderna para proporcionar una interfaz intuitiva y profesional.</p>
      
      <p><strong>Caracter√≠sticas principales:</strong></p>
      <ul style="padding-left: 1.5rem; line-height: 1.8; color: #5a6c7d;">
        <li>An√°lisis de respuesta en frecuencia (Bode y Nyquist)</li>
        <li>Osciloscopio digital de dos canales con trigger</li>
        <li>Comunicaci√≥n MQTT con dispositivos ESP32</li>
        <li>Exportaci√≥n de datos en formato PNG y CSV</li>
        <li>Interfaz web responsive y profesional</li>
      </ul>
    </div>
  </div>

  <!-- SECCI√ìN BODE -->
  <div class="content-section" id="bode">
    <div class="card">
      <h2>Diagrama de Bode</h2>
      
      <!-- Controles de medici√≥n -->
      <div class="measurement-controls">
        <div class="form-inline">
          <div class="form-group" style="flex: 2;">
            <label>Etiqueta de Medici√≥n</label>
            <input id="measurementLabel" type="text" class="form-control" placeholder="Ej: Filtro RC 1kHz" value="Medici√≥n 1">
          </div>
          <button class="btn" id="startMeasurementBtn">üöÄ Nueva Medici√≥n</button>
          <button class="btn btn-danger" id="clearBodeBtn">üóëÔ∏è Borrar Todo</button>
          <button class="btn btn-secondary" id="clearLastBodeBtn">‚Ü©Ô∏è Borrar √öltima</button>
        </div>
      </div>
      
      <!-- Listado de mediciones -->
      <div id="measurementList" class="measurement-list">
        <span class="empty-measurements">No hay mediciones todav√≠a</span>
      </div>
      
      <div class="charts-grid">
        <div class="chart-container">
          <h3>Magnitud [dB]</h3>
          <canvas id="chartMag"></canvas>
          <div class="download-options">
            <button class="btn btn-secondary" data-action="download-mag-png">Descargar PNG</button>
            <button class="btn btn-secondary" data-action="download-mag-csv">Descargar CSV</button>
          </div>
        </div>
        <div class="chart-container">
          <h3>Fase [¬∞]</h3>
          <canvas id="chartPhase"></canvas>
          <div class="download-options">
            <button class="btn btn-secondary" data-action="download-phase-png">Descargar PNG</button>
            <button class="btn btn-secondary" data-action="download-phase-csv">Descargar CSV</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- SECCI√ìN NYQUIST -->
  <div class="content-section" id="nyquist">
    <div class="card">
      <h2>Diagrama de Nyquist</h2>
      
      <!-- Controles de medici√≥n -->
      <div class="measurement-controls">
        <div class="form-inline">
          <div class="form-group" style="flex: 2;">
            <label>Etiqueta de Medici√≥n</label>
            <input id="measurementLabelNyquist" type="text" class="form-control" placeholder="Ej: Filtro RC 1kHz" value="Medici√≥n 1">
          </div>
          <button class="btn" id="startMeasurementNyquistBtn">üöÄ Nueva Medici√≥n</button>
          <button class="btn btn-danger" id="clearNyquistBtn">üóëÔ∏è Borrar Todo</button>
          <button class="btn btn-secondary" id="clearLastNyquistBtn">‚Ü©Ô∏è Borrar √öltima</button>
        </div>
      </div>
      
      <!-- Listado de mediciones -->
      <div id="measurementListNyquist" class="measurement-list">
        <span class="empty-measurements">No hay mediciones todav√≠a</span>
      </div>
      
      <div class="chart-container full-width-chart">
        <canvas id="chartNyquist"></canvas>
        <div class="download-options">
          <button class="btn btn-secondary" data-action="download-nyquist-png">Descargar PNG</button>
          <button class="btn btn-secondary" data-action="download-nyquist-csv">Descargar CSV</button>
        </div>
      </div>
    </div>
  </div>

  <!-- SECCI√ìN OSCILOSCOPIO MEJORADO -->
  <div class="content-section" id="osciloscopio">
    <div class="card">
      <h2>üî¨ Osciloscopio Digital</h2>
      
      <!-- Barra de informaci√≥n -->
      <div class="info-bar">
        <div class="info-bar-item">
          <span class="info-label">Escala Tiempo:</span>
          <span class="info-value" id="timeScaleDisplay">500 muestras</span>
        </div>
        <div class="info-bar-item">
          <span class="info-label">CH1 Escala:</span>
          <span class="info-value" id="ch1ScaleDisplay">4095 LSB</span>
        </div>
        <div class="info-bar-item">
          <span class="info-label">CH2 Escala:</span>
          <span class="info-value" id="ch2ScaleDisplay">4095 LSB</span>
        </div>
        <div class="info-bar-item">
          <span class="info-label">Muestras:</span>
          <span class="info-value" id="sampleCountDisplay">0</span>
        </div>
      </div>

      <!-- Controles de canales mejorados -->
      <div class="channel-controls">
        <div class="channel-panel ch1">
          <h3>üìä Canal 1 (Azul)</h3>
          <div class="channel-buttons">
            <button class="btn" data-cmd="CH1ON">ON</button>
            <button class="btn btn-danger" data-cmd="CH1OFF">OFF</button>
          </div>
          <div class="control-group">
            <label>
              <span>Escala Vertical</span>
              <span class="scale-value" id="ch1ScaleValue">4095 LSB</span>
            </label>
            <input type="range" id="ch1Scale" min="100" max="4095" value="4095" step="50">
            <select id="ch1ScalePreset" class="form-control">
              <option value="4095">Escala Completa (0-4095)</option>
              <option value="2048">Media Escala (¬±2048)</option>
              <option value="1024">1/4 Escala (¬±1024)</option>
              <option value="512">1/8 Escala (¬±512)</option>
              <option value="256">1/16 Escala (¬±256)</option>
              <option value="128">1/32 Escala (¬±128)</option>
            </select>
          </div>
          <div class="control-group">
            <label>
              <span>Offset Vertical</span>
              <span class="scale-value" id="ch1OffsetValue">2048</span>
            </label>
            <input type="range" id="ch1Offset" min="0" max="4095" value="2048" step="10">
          </div>
        </div>

        <div class="channel-panel ch2">
          <h3>üìä Canal 2 (Gris)</h3>
          <div class="channel-buttons">
            <button class="btn" data-cmd="CH2ON">ON</button>
            <button class="btn btn-danger" data-cmd="CH2OFF">OFF</button>
          </div>
          <div class="control-group">
            <label>
              <span>Escala Vertical</span>
              <span class="scale-value" id="ch2ScaleValue">4095 LSB</span>
            </label>
            <input type="range" id="ch2Scale" min="100" max="4095" value="4095" step="50">
            <select id="ch2ScalePreset" class="form-control">
              <option value="4095">Escala Completa (0-4095)</option>
              <option value="2048">Media Escala (¬±2048)</option>
              <option value="1024">1/4 Escala (¬±1024)</option>
              <option value="512">1/8 Escala (¬±512)</option>
              <option value="256">1/16 Escala (¬±256)</option>
              <option value="128">1/32 Escala (¬±128)</option>
            </select>
          </div>
          <div class="control-group">
            <label>
              <span>Offset Vertical</span>
              <span class="scale-value" id="ch2OffsetValue">2048</span>
            </label>
            <input type="range" id="ch2Offset" min="0" max="4095" value="2048" step="10">
          </div>
        </div>
      </div>

      <!-- Controles de tiempo -->
      <div class="oscilloscope-controls">
        <div class="control-group">
          <label>
            <span>‚è±Ô∏è Escala Horizontal</span>
            <span class="scale-value" id="timescaleValue">500 muestras</span>
          </label>
          <input type="range" id="timescale" min="50" max="1000" value="500" step="50">
          <select id="timescalePreset" class="form-control">
            <option value="100">100 muestras (r√°pido)</option>
            <option value="250">250 muestras</option>
            <option value="500" selected>500 muestras</option>
            <option value="750">750 muestras</option>
            <option value="1000">1000 muestras (lento)</option>
          </select>
        </div>

        <div class="control-group">
          <label>üîÑ Modo de Actualizaci√≥n</label>
          <select id="updateMode" class="form-control">
            <option value="continuous">Continuo</option>
            <option value="single" selected>Disparo √önico</option>
          </select>
        </div>

        <div class="control-group">
          <label>üìà Interpolaci√≥n</label>
          <select id="interpolation" class="form-control">
            <option value="0">Sin interpolaci√≥n</option>
            <option value="0.1" selected>Suave</option>
            <option value="0.3">Muy suave</option>
          </select>
        </div>
      </div>

      <!-- Controles de trigger originales -->
      <div class="adc-trigger-controls">
        <div class="form-group">
          <label>Trigger</label>
          <select id="triggerChannel" class="form-control">
            <option value="none">Deshabilitado</option>
            <option value="ch1">Canal 1</option>
            <option value="ch2">Canal 2</option>
          </select>
        </div>
        <div class="form-group">
          <label>Nivel</label>
          <input id="triggerLevel" type="number" class="form-control" value="2048" min="0" max="4095">
        </div>
        <div class="form-group">
          <label>Modo</label>
          <select id="triggerMode" class="form-control">
            <option value="rising">Flanco Ascendente</option>
            <option value="falling">Flanco Descendente</option>
          </select>
        </div>
        <button class="btn btn-secondary" id="clearADCBtn">Limpiar</button>
      </div>

      <div class="chart-container">
        <canvas id="chartADC"></canvas>
        <div class="download-options">
          <button class="btn btn-secondary" data-action="download-adc-png">Descargar PNG</button>
        </div>
      </div>
    </div>
  </div>

  <!-- SECCI√ìN CONEXI√ìN -->
  <div class="content-section" id="conexion">
    <div class="card">
      <h2>Conexi√≥n y Control</h2>
      <form id="commandForm">
        <div class="form-inline">
          <div class="form-group">
            <label>ID del Dispositivo</label>
            <input id="deviceId" type="text" class="form-control" placeholder="ESP32_A1" required>
          </div>
          <button type="button" class="btn" id="connectBtn">Conectar</button>
        </div>

        <div class="form-inline" style="margin-top: 1rem;">
          <div class="form-group">
            <label>Comando</label>
            <input id="inputData" type="text" class="form-control" placeholder="-10;1000A o 1.57;1000F o S1000">
          </div>
          <button type="submit" class="btn">Enviar</button>
        </div>
      </form>
      
      <div class="form-group" style="margin-top: 1.5rem;">
        <label>Consola</label>
        <pre id="log" class="console-box"></pre>
      </div>
    </div>
  </div>
</div>

<script>
// Cargar Socket.IO din√°micamente
function loadSocketIO() {
  return new Promise((resolve, reject) => {
    const script1 = document.createElement('script');
    script1.src = '/socket.io/socket.io.js';
    script1.onload = () => {
      console.log('‚úÖ Socket.IO cargado desde servidor');
      resolve();
    };
    script1.onerror = () => {
      console.log('‚ö†Ô∏è No se pudo cargar desde servidor, intentando CDN...');
      const script2 = document.createElement('script');
      script2.src = 'https://cdn.socket.io/4.7.2/socket.io.min.js';
      script2.crossOrigin = 'anonymous';
      script2.onload = () => {
        console.log('‚úÖ Socket.IO cargado desde CDN');
        resolve();
      };
      script2.onerror = () => {
        console.error('‚ùå No se pudo cargar Socket.IO');
        reject(new Error('Socket.IO no disponible'));
      };
      document.head.appendChild(script2);
    };
    document.head.appendChild(script1);
  });
}

// Variables globales
let socket;
let currentDevice = null;
let latestMagnitude = NaN;
let latestPhase = NaN;
let adcBuffer = { ch1: [], ch2: [] };
let sampleCounter = 0;
let triggerArmed = false;
let triggerTriggered = false;
let MAX_ADC_SAMPLES = 500;

// Variables para multi-medici√≥n
let measurements = [];
let currentMeasurementIndex = -1;
let measurementColors = [
  '#2c5aa0', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6', 
  '#1abc9c', '#34495e', '#e67e22', '#95a5a6', '#c0392b'
];

// Variables para osciloscopio mejorado
let ch1Scale = 4095;
let ch1Offset = 2048;
let ch2Scale = 4095;
let ch2Offset = 2048;
let updateMode = 'single';
let interpolationTension = 0.1;

// Inicializar Socket.IO
async function initializeSocket() {
  try {
    await loadSocketIO();
    
    if (typeof io === 'undefined') {
      throw new Error('Socket.IO no disponible');
    }
    
    socket = io();
    console.log('‚úÖ Socket.IO conectado');
    
    socket.on("update_data", ({ deviceId, payload }) => {
      if (!currentDevice || deviceId !== currentDevice) return;
      if (typeof payload === "string") parsePlot(payload);
      else if (payload.msg) parsePlot(payload.msg);
    });

    socket.on("adc_data", ({ deviceId, data }) => {
      if (!currentDevice || deviceId !== currentDevice) return;
      parseADCData(data);
    });
    
    socket.on('connect', () => {
      log('‚úÖ Conectado al servidor');
      console.log('‚úÖ Conectado al servidor MQTT');
    });
    
    socket.on('disconnect', () => {
      log('‚ö†Ô∏è Desconectado del servidor');
      console.log('‚ö†Ô∏è Desconectado del servidor MQTT');
    });
    
    socket.on('error', (error) => {
      log('‚ùå Error de conexi√≥n: ' + error);
      console.error('‚ùå Error:', error);
    });
    
  } catch (error) {
    console.error('‚ùå Error al inicializar Socket.IO:', error);
    log('‚ùå No se pudo conectar al servidor. Aseg√∫rate de que el servidor est√© corriendo.');
  }
}

// Configuraci√≥n de Charts
Chart.defaults.font.family = 'Roboto';
Chart.defaults.font.size = 12;
Chart.defaults.color = '#5a6c7d';

// Crear gr√°ficos con soporte multi-medici√≥n
const chartMag = new Chart(document.getElementById('chartMag'), {
  type: 'line',
  data: {
    datasets: []
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: { 
      legend: { display: true, position: 'top' },
      tooltip: {
        mode: 'index',
        intersect: false
      }
    },
    scales: {
      x: {
        type: 'logarithmic',
        title: { display: true, text: 'Frecuencia [Hz]' },
        grid: { color: 'rgba(0,0,0,0.05)' }
      },
      y: {
        title: { display: true, text: 'Magnitud [dB]' },
        grid: { color: 'rgba(0,0,0,0.05)' }
      }
    }
  }
});

const chartPhase = new Chart(document.getElementById('chartPhase'), {
  type: 'line',
  data: {
    datasets: []
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: { 
      legend: { display: true, position: 'top' },
      tooltip: {
        mode: 'index',
        intersect: false
      }
    },
    scales: {
      x: {
        type: 'logarithmic',
        title: { display: true, text: 'Frecuencia [Hz]' },
        grid: { color: 'rgba(0,0,0,0.05)' }
      },
      y: {
        title: { display: true, text: 'Fase [¬∞]' },
        grid: { color: 'rgba(0,0,0,0.05)' }
      }
    }
  }
});

const chartNyquist = new Chart(document.getElementById('chartNyquist'), {
  type: 'scatter',
  data: {
    datasets: []
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: { 
      legend: { display: true, position: 'top' },
      tooltip: {
        callbacks: {
          label: function(context) {
            return `${context.dataset.label}: Re=${context.parsed.x.toFixed(3)}, Im=${context.parsed.y.toFixed(3)}`;
          }
        }
      }
    },
    scales: {
      x: {
        title: { display: true, text: 'Re' },
        grid: { color: 'rgba(0,0,0,0.05)' }
      },
      y: {
        title: { display: true, text: 'Im' },
        grid: { color: 'rgba(0,0,0,0.05)' }
      }
    }
  }
});

const chartADC = new Chart(document.getElementById('chartADC'), {
  type: 'line',
  data: {
    labels: [],
    datasets: [
      {
        label: 'Canal 1',
        data: [],
        borderColor: '#2c5aa0',
        backgroundColor: 'rgba(44, 90, 160, 0.1)',
        borderWidth: 2,
        fill: false,
        tension: 0.1,
        pointRadius: 0,
        yAxisID: 'y'
      },
      {
        label: 'Canal 2',
        data: [],
        borderColor: '#6c757d',
        backgroundColor: 'rgba(108, 117, 125, 0.1)',
        borderWidth: 2,
        fill: false,
        tension: 0.1,
        pointRadius: 0,
        yAxisID: 'y1'
      }
    ]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    animation: false,
    interaction: { mode: 'index', intersect: false },
    plugins: { legend: { display: true } },
    scales: {
      x: {
        title: { display: true, text: 'Muestras' },
        grid: { color: 'rgba(0,0,0,0.05)' }
      },
      y: {
        position: 'left',
        title: { display: true, text: 'Canal 1 (0-4095)' },
        min: 0,
        max: 4095,
        grid: { color: 'rgba(44, 90, 160, 0.1)' }
      },
      y1: {
        position: 'right',
        title: { display: true, text: 'Canal 2 (0-4095)' },
        min: 0,
        max: 4095,
        grid: { drawOnChartArea: false }
      }
    }
  }
});

// Funciones de utilidad
function log(msg) {
  const logEl = document.getElementById("log");
  logEl.textContent += msg + "\n";
  logEl.scrollTop = logEl.scrollHeight;
}

function showSection(sectionId) {
  document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
  
  const section = document.getElementById(sectionId);
  if (section) {
    section.classList.add('active');
  }
  
  document.querySelectorAll('.menu-item').forEach(item => {
    if (item.getAttribute('data-section') === sectionId) {
      item.classList.add('active');
    }
  });
}

// Funciones de conexi√≥n
function connectDevice() {
  const id = document.getElementById("deviceId").value.trim();
  if (!id) return log("‚ö†Ô∏è Ingrese un ID de dispositivo.");
  if (!socket || !socket.connected) {
    log("‚ùå Socket.IO no est√° conectado. Espera un momento o recarga la p√°gina.");
    return;
  }
  
  currentDevice = id;
  socket.emit("join_device", id);
  socket.emit("connect_device", id);
  log(`üì° Intentando conectar con ${id}...`);
}

function sendData(e) {
  e.preventDefault();
  const v = document.getElementById("inputData").value.trim();
  const id = document.getElementById("deviceId").value.trim();
  if (!v || !id) return;
  if (!socket || !socket.connected) {
    log("‚ùå Socket.IO no est√° conectado");
    return;
  }
  
  socket.emit("send_command", { deviceId: id, command: v });
  log(`üì§ Enviado a ${id}: ${v}`);
  document.getElementById("inputData").value = "";
}

function sendCommand(cmd) {
  const id = document.getElementById("deviceId").value.trim();
  if (!id) {
    log("‚ö†Ô∏è Conecta primero a un dispositivo");
    return;
  }
  if (!socket || !socket.connected) {
    log("‚ùå Socket.IO no est√° conectado");
    return;
  }
  
  socket.emit("send_command", { deviceId: id, command: cmd });
  log(`üì§ Comando: ${cmd}`);
}

// Funciones para gesti√≥n de mediciones
function startNewMeasurement() {
  const label = document.getElementById('measurementLabel').value.trim() || `Medici√≥n ${measurements.length + 1}`;
  const color = measurementColors[measurements.length % measurementColors.length];
  
  const newMeasurement = {
    label: label,
    color: color,
    magnitude: {
      frequencies: [],
      values: []
    },
    phase: {
      frequencies: [],
      values: []
    },
    nyquist: []
  };
  
  measurements.push(newMeasurement);
  currentMeasurementIndex = measurements.length - 1;
  
  updateMeasurementList();
  updateBodeCharts();
  updateNyquistChart();
  
  log(`üìä Nueva medici√≥n iniciada: ${label}`);
  
  // Incrementar contador para pr√≥xima medici√≥n
  document.getElementById('measurementLabel').value = `Medici√≥n ${measurements.length + 1}`;
  document.getElementById('measurementLabelNyquist').value = `Medici√≥n ${measurements.length + 1}`;
  
  // Enviar comando STARTFR
  sendCommand('STARTFR');
}

function updateBodeCharts() {
  // Actualizar gr√°fico de magnitud
  chartMag.data.datasets = measurements.map(m => ({
    label: m.label,
    data: m.magnitude.frequencies.map((f, i) => ({ x: f * 2 * Math.PI, y: m.magnitude.values[i] })),
    borderColor: m.color,
    backgroundColor: hexToRGBA(m.color, 0.1),
    borderWidth: 2,
    fill: false,
    tension: 0.3,
    pointRadius: 3,
    pointBackgroundColor: m.color
  }));
  chartMag.update('none');

  // Actualizar gr√°fico de fase
  chartPhase.data.datasets = measurements.map(m => ({
    label: m.label,
    data: m.phase.frequencies.map((f, i) => ({ x: f * 2 * Math.PI, y: m.phase.values[i] * 180 / Math.PI })),
    borderColor: m.color,
    backgroundColor: hexToRGBA(m.color, 0.1),
    borderWidth: 2,
    fill: false,
    tension: 0.3,
    pointRadius: 3,
    pointBackgroundColor: m.color
  }));
  chartPhase.update('none');
}

function updateNyquistChart() {
  chartNyquist.data.datasets = measurements.map(m => ({
    label: m.label,
    data: m.nyquist,
    borderColor: m.color,
    backgroundColor: hexToRGBA(m.color, 0.5),
    borderWidth: 2,
    pointRadius: 4,
    showLine: true,
    fill: false,
    tension: 0.2
  }));
  chartNyquist.update('none');
}

function updateMeasurementList() {
  const listBode = document.getElementById('measurementList');
  const listNyquist = document.getElementById('measurementListNyquist');
  
  if (measurements.length === 0) {
    listBode.innerHTML = '<span class="empty-measurements">No hay mediciones todav√≠a</span>';
    listNyquist.innerHTML = '<span class="empty-measurements">No hay mediciones todav√≠a</span>';
    return;
  }
  
  const html = measurements.map((m, i) => `
    <div class="measurement-tag" style="background-color: ${m.color};">
      <span class="color-dot" style="background-color: ${m.color};"></span>
      <span>${m.label}</span>
      <span>(${m.magnitude.values.length} pts)</span>
    </div>
  `).join('');
  
  listBode.innerHTML = html;
  listNyquist.innerHTML = html;
}

function clearAllBode() {
  measurements = [];
  currentMeasurementIndex = -1;
  latestMagnitude = NaN;
  latestPhase = NaN;
  
  updateBodeCharts();
  updateNyquistChart();
  updateMeasurementList();
  
  document.getElementById('measurementLabel').value = 'Medici√≥n 1';
  document.getElementById('measurementLabelNyquist').value = 'Medici√≥n 1';
  
  log('üóëÔ∏è Todas las mediciones borradas');
}

function clearLastMeasurement() {
  if (measurements.length > 0) {
    const removed = measurements.pop();
    currentMeasurementIndex = measurements.length - 1;
    
    updateBodeCharts();
    updateNyquistChart();
    updateMeasurementList();
    
    log(`‚Ü©Ô∏è Medici√≥n "${removed.label}" eliminada`);
  } else {
    log('‚ö†Ô∏è No hay mediciones para eliminar');
  }
}

function hexToRGBA(hex, alpha) {
  const r = parseInt(hex.slice(1, 3), 16);
  const g = parseInt(hex.slice(3, 5), 16);
  const b = parseInt(hex.slice(5, 7), 16);
  return `rgba(${r}, ${g}, ${b}, ${alpha})`;
}

// Funciones de parseo
function parsePlot(msg) {
  const m = msg.match(/^([-+]?[0-9]*\.?[0-9]+);([0-9]*\.?[0-9]+)([AF])$/);
  if (!m) {
    log("‚ö†Ô∏è Formato inv√°lido: " + msg);
    return;
  }
  const val = parseFloat(m[1]), freq = parseFloat(m[2]), type = m[3];

  // Si no hay medici√≥n activa, crear una nueva
  if (currentMeasurementIndex === -1) {
    startNewMeasurement();
  }

  const currentMeasurement = measurements[currentMeasurementIndex];

  if (type === "A") {
    currentMeasurement.magnitude.frequencies.push(freq);
    currentMeasurement.magnitude.values.push(val);
    updateBodeCharts();
    
    latestMagnitude = Math.pow(10, val / 20);
    if (!isNaN(latestPhase)) addNyquist(latestMagnitude, latestPhase);
  } else if (type === "F") {
    currentMeasurement.phase.frequencies.push(freq);
    currentMeasurement.phase.values.push(val);
    updateBodeCharts();
    
    latestPhase = val;
    if (!isNaN(latestMagnitude)) addNyquist(latestMagnitude, latestPhase);
  }
}

function addNyquist(mag, phase) {
  if (currentMeasurementIndex === -1) {
    return;
  }

  const re = mag * Math.cos(phase);
  const im = mag * Math.sin(phase);
  
  measurements[currentMeasurementIndex].nyquist.push({ x: re, y: im });
  updateNyquistChart();
}

// Funci√≥n mejorada para actualizar escalas del gr√°fico
function updateChartScales() {
  const ch1Min = Math.max(0, ch1Offset - ch1Scale);
  const ch1Max = Math.min(4095, ch1Offset + ch1Scale);
  const ch2Min = Math.max(0, ch2Offset - ch2Scale);
  const ch2Max = Math.min(4095, ch2Offset + ch2Scale);

  chartADC.options.scales.y.min = ch1Min;
  chartADC.options.scales.y.max = ch1Max;
  chartADC.options.scales.y1.min = ch2Min;
  chartADC.options.scales.y1.max = ch2Max;
  
  chartADC.update('none');
}

function parseADCData(data) {
  const match = data.match(/CH1:(\d+),CH2:(\d+)/);
  if (!match) return;

  const ch1 = parseInt(match[1]);
  const ch2 = parseInt(match[2]);

  adcBuffer.ch1.push(ch1);
  adcBuffer.ch2.push(ch2);
  sampleCounter++;
  
  // Actualizar contador en pantalla
  document.getElementById('sampleCountDisplay').textContent = sampleCounter;

  const triggerChannel = document.getElementById('triggerChannel').value;
  const triggerLevel = parseInt(document.getElementById('triggerLevel').value);
  const triggerMode = document.getElementById('triggerMode').value;

  let triggerValue = (triggerChannel === 'ch1') ? ch1 : (triggerChannel === 'ch2') ? ch2 : null;

  if (triggerChannel !== 'none' && triggerValue !== null) {
    if (!triggerArmed) {
      if (triggerMode === 'rising' && triggerValue > triggerLevel) {
        triggerArmed = true;
        triggerTriggered = false;
      } else if (triggerMode === 'falling' && triggerValue < triggerLevel) {
        triggerArmed = true;
        triggerTriggered = false;
      }
    } else if (!triggerTriggered) {
      if (triggerMode === 'rising' && triggerValue <= triggerLevel) {
        triggerTriggered = true;
      } else if (triggerMode === 'falling' && triggerValue >= triggerLevel) {
        triggerTriggered = true;
      }
    }
  } else {
    triggerArmed = true;
    triggerTriggered = true;
  }

  const shouldUpdate = updateMode === 'continuous' || 
                      (adcBuffer.ch1.length >= MAX_ADC_SAMPLES && triggerTriggered);

  if (shouldUpdate) {
    updateADCChart();
    if (updateMode === 'single') {
      adcBuffer.ch1 = [];
      adcBuffer.ch2 = [];
      sampleCounter = 0;
      triggerArmed = false;
      triggerTriggered = false;
    }
  }
}

function updateADCChart() {
  const dataLength = Math.min(adcBuffer.ch1.length, MAX_ADC_SAMPLES);
  const startIdx = Math.max(0, adcBuffer.ch1.length - MAX_ADC_SAMPLES);
  
  chartADC.data.labels = [];
  for (let i = 0; i < dataLength; i++) {
    chartADC.data.labels.push(i.toString());
  }
  chartADC.data.datasets[0].data = adcBuffer.ch1.slice(startIdx);
  chartADC.data.datasets[1].data = adcBuffer.ch2.slice(startIdx);
  chartADC.update('none');
}

function clearADCChart() {
  chartADC.data.labels = [];
  chartADC.data.datasets[0].data = [];
  chartADC.data.datasets[1].data = [];
  chartADC.update('none');
  adcBuffer.ch1 = [];
  adcBuffer.ch2 = [];
  sampleCounter = 0;
  document.getElementById('sampleCountDisplay').textContent = '0';
}

// Funciones de descarga
function downloadChart(chart, filename) {
  const link = document.createElement('a');
  link.href = chart.toBase64Image();
  link.download = filename;
  link.click();
}

function downloadBodeCSV(type) {
  let csv = '';

  if (type === 'magnitude') {
    csv = 'Medici√≥n,Frecuencia [Hz],Magnitud [dB]\n';
    measurements.forEach(m => {
      m.magnitude.frequencies.forEach((f, i) => {
        const freqHz = f * 2 * Math.PI;
        csv += `${m.label},${freqHz},${m.magnitude.values[i]}\n`;
      });
    });
  } else {
    csv = 'Medici√≥n,Frecuencia [Hz],Fase [¬∞]\n';
    measurements.forEach(m => {
      m.phase.frequencies.forEach((f, i) => {
        const freqHz = f * 2 * Math.PI;
        const phaseDeg = m.phase.values[i] * 180 / Math.PI;
        csv += `${m.label},${freqHz},${phaseDeg}\n`;
      });
    });
  }

  const blob = new Blob([csv], { type: 'text/csv' });
  const url = window.URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = type === 'magnitude' ? 'magnitud.csv' : 'fase.csv';
  link.click();
  window.URL.revokeObjectURL(url);
}

function downloadNyquistCSV() {
  let csv = 'Medici√≥n,Re,Im\n';
  measurements.forEach(m => {
    m.nyquist.forEach(point => {
      csv += `${m.label},${point.x},${point.y}\n`;
    });
  });
  
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = window.URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = 'nyquist.csv';
  link.click();
  window.URL.revokeObjectURL(url);
}

function downloadAllCharts() {
  downloadChart(chartMag, 'magnitud.png');
  downloadChart(chartPhase, 'fase.png');
  downloadChart(chartNyquist, 'nyquist.png');
  downloadChart(chartADC, 'osciloscopio.png');
  downloadBodeCSV('magnitude');
  downloadBodeCSV('phase');
  downloadNyquistCSV();
  log('‚úÖ Gr√°ficos descargados correctamente');
}

// Inicializar eventos despu√©s de cargar el DOM
document.addEventListener('DOMContentLoaded', function() {
  console.log('‚úÖ Inicializando FRA Monitor...');
  
  // Inicializar Socket.IO
  initializeSocket();
  
  // Men√∫ de navegaci√≥n
  const menuItems = document.querySelectorAll('.menu-item');
  menuItems.forEach(function(item) {
    item.addEventListener('click', function() {
      const sectionId = this.getAttribute('data-section');
      showSection(sectionId);
    });
  });

  // Bot√≥n de descargar todo
  const downloadAllBtn = document.getElementById('downloadAllBtn');
  if (downloadAllBtn) {
    downloadAllBtn.addEventListener('click', function() {
      downloadAllCharts();
    });
  }

  // Botones de medici√≥n Bode
  document.getElementById('startMeasurementBtn').addEventListener('click', function() {
    const id = document.getElementById("deviceId").value.trim();
    if (!id) {
      log("‚ö†Ô∏è Conecta primero a un dispositivo");
      return;
    }
    startNewMeasurement();
  });

  document.getElementById('clearBodeBtn').addEventListener('click', function() {
    if (confirm('¬øEst√°s seguro de que quieres borrar todas las mediciones?')) {
      clearAllBode();
    }
  });

  document.getElementById('clearLastBodeBtn').addEventListener('click', function() {
    clearLastMeasurement();
  });

  // Botones de medici√≥n Nyquist (mismo comportamiento)
  document.getElementById('startMeasurementNyquistBtn').addEventListener('click', function() {
    const id = document.getElementById("deviceId").value.trim();
    if (!id) {
      log("‚ö†Ô∏è Conecta primero a un dispositivo");
      return;
    }
    const label = document.getElementById('measurementLabelNyquist').value.trim();
    document.getElementById('measurementLabel').value = label;
    startNewMeasurement();
  });

  document.getElementById('clearNyquistBtn').addEventListener('click', function() {
    if (confirm('¬øEst√°s seguro de que quieres borrar todas las mediciones?')) {
      clearAllBode();
    }
  });

  document.getElementById('clearLastNyquistBtn').addEventListener('click', function() {
    clearLastMeasurement();
  });

  // Bot√≥n conectar
  const connectBtn = document.getElementById('connectBtn');
  if (connectBtn) {
    connectBtn.addEventListener('click', function() {
      connectDevice();
    });
  }

  // Formulario de comandos
  const commandForm = document.getElementById('commandForm');
  if (commandForm) {
    commandForm.addEventListener('submit', function(e) {
      sendData(e);
    });
  }

  // Botones de canal ADC
  const cmdButtons = document.querySelectorAll('[data-cmd]');
  cmdButtons.forEach(function(btn) {
    btn.addEventListener('click', function() {
      const cmd = this.getAttribute('data-cmd');
      sendCommand(cmd);
    });
  });

  // Bot√≥n limpiar ADC
  const clearADCBtn = document.getElementById('clearADCBtn');
  if (clearADCBtn) {
    clearADCBtn.addEventListener('click', function() {
      clearADCChart();
    });
  }

  // Botones de descarga individual
  const actionButtons = document.querySelectorAll('[data-action]');
  actionButtons.forEach(function(btn) {
    btn.addEventListener('click', function() {
      const action = this.getAttribute('data-action');
      
      if (action === 'download-mag-png') {
        downloadChart(chartMag, 'magnitud.png');
      } else if (action === 'download-mag-csv') {
        downloadBodeCSV('magnitude');
      } else if (action === 'download-phase-png') {
        downloadChart(chartPhase, 'fase.png');
      } else if (action === 'download-phase-csv') {
        downloadBodeCSV('phase');
      } else if (action === 'download-nyquist-png') {
        downloadChart(chartNyquist, 'nyquist.png');
      } else if (action === 'download-nyquist-csv') {
        downloadNyquistCSV();
      } else if (action === 'download-adc-png') {
        downloadChart(chartADC, 'osciloscopio.png');
      }
    });
  });

  // NUEVOS EVENT LISTENERS PARA OSCILOSCOPIO MEJORADO
  
  // Control de escala CH1
  document.getElementById('ch1Scale').addEventListener('input', function(e) {
    ch1Scale = parseInt(e.target.value);
    document.getElementById('ch1ScaleValue').textContent = ch1Scale + ' LSB';
    document.getElementById('ch1ScaleDisplay').textContent = ch1Scale + ' LSB';
    updateChartScales();
  });

  document.getElementById('ch1Offset').addEventListener('input', function(e) {
    ch1Offset = parseInt(e.target.value);
    document.getElementById('ch1OffsetValue').textContent = ch1Offset;
    updateChartScales();
  });

  document.getElementById('ch1ScalePreset').addEventListener('change', function(e) {
    const scale = parseInt(e.target.value);
    document.getElementById('ch1Scale').value = scale;
    ch1Scale = scale;
    document.getElementById('ch1ScaleValue').textContent = scale + ' LSB';
    document.getElementById('ch1ScaleDisplay').textContent = scale + ' LSB';
    updateChartScales();
  });

  // Control de escala CH2
  document.getElementById('ch2Scale').addEventListener('input', function(e) {
    ch2Scale = parseInt(e.target.value);
    document.getElementById('ch2ScaleValue').textContent = ch2Scale + ' LSB';
    document.getElementById('ch2ScaleDisplay').textContent = ch2Scale + ' LSB';
    updateChartScales();
  });

  document.getElementById('ch2Offset').addEventListener('input', function(e) {
    ch2Offset = parseInt(e.target.value);
    document.getElementById('ch2OffsetValue').textContent = ch2Offset;
    updateChartScales();
  });

  document.getElementById('ch2ScalePreset').addEventListener('change', function(e) {
    const scale = parseInt(e.target.value);
    document.getElementById('ch2Scale').value = scale;
    ch2Scale = scale;
    document.getElementById('ch2ScaleValue').textContent = scale + ' LSB';
    document.getElementById('ch2ScaleDisplay').textContent = scale + ' LSB';
    updateChartScales();
  });

  // Control de escala temporal
  document.getElementById('timescale').addEventListener('input', function(e) {
    MAX_ADC_SAMPLES = parseInt(e.target.value);
    document.getElementById('timescaleValue').textContent = MAX_ADC_SAMPLES + ' muestras';
    document.getElementById('timeScaleDisplay').textContent = MAX_ADC_SAMPLES + ' muestras';
  });

  document.getElementById('timescalePreset').addEventListener('change', function(e) {
    const samples = parseInt(e.target.value);
    document.getElementById('timescale').value = samples;
    MAX_ADC_SAMPLES = samples;
    document.getElementById('timescaleValue').textContent = samples + ' muestras';
    document.getElementById('timeScaleDisplay').textContent = samples + ' muestras';
  });

  // Modo de actualizaci√≥n
  document.getElementById('updateMode').addEventListener('change', function(e) {
    updateMode = e.target.value;
  });

  // Interpolaci√≥n
  document.getElementById('interpolation').addEventListener('change', function(e) {
    interpolationTension = parseFloat(e.target.value);
    chartADC.data.datasets[0].tension = interpolationTension;
    chartADC.data.datasets[1].tension = interpolationTension;
    chartADC.update('none');
  });
  
  log('‚úÖ FRA Monitor inicializado correctamente');
  console.log('‚úÖ FRA Monitor listo para usar');
});
</script>

</body>
</html>
