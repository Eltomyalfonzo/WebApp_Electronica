<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Osciloscopio Mejorado - FRA Monitor</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Roboto', sans-serif;
      background: #f5f7fa;
      color: #2c3e50;
      padding: 2rem;
    }

    .card {
      background: white;
      border-radius: 8px;
      padding: 1.5rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      margin-bottom: 1.5rem;
    }

    .card h2 {
      color: #1a2332;
      font-size: 1.3rem;
      font-weight: 500;
      margin-bottom: 1rem;
      padding-bottom: 0.8rem;
      border-bottom: 2px solid #e1e8ed;
    }

    .oscilloscope-controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
      background: #f8f9fa;
      padding: 1rem;
      border-radius: 6px;
    }

    .control-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .control-group label {
      color: #1a2332;
      font-weight: 500;
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .control-group select,
    .control-group input {
      padding: 0.5rem;
      border: 1px solid #d1d9e0;
      border-radius: 4px;
      font-family: 'Roboto', sans-serif;
      font-size: 0.9rem;
    }

    .control-group input[type="range"] {
      cursor: pointer;
    }

    .scale-value {
      color: #2c5aa0;
      font-weight: 600;
      font-size: 0.9rem;
    }

    .channel-controls {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .channel-panel {
      background: #f8f9fa;
      padding: 1rem;
      border-radius: 6px;
      border-left: 4px solid #2c5aa0;
    }

    .channel-panel.ch2 {
      border-left-color: #6c757d;
    }

    .channel-panel h3 {
      color: #1a2332;
      font-size: 1rem;
      margin-bottom: 0.8rem;
    }

    .channel-buttons {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.8rem;
    }

    .btn {
      background: #2c5aa0;
      color: white;
      border: none;
      padding: 0.6rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
      font-size: 0.85rem;
      transition: all 0.3s ease;
      flex: 1;
    }

    .btn:hover {
      background: #3d6fb8;
      box-shadow: 0 2px 8px rgba(44, 90, 160, 0.3);
    }

    .btn-danger {
      background: #dc3545;
    }

    .btn-danger:hover {
      background: #c82333;
    }

    .btn-secondary {
      background: #6c757d;
    }

    .btn-secondary:hover {
      background: #5a6268;
    }

    .trigger-controls {
      background: #f8f9fa;
      padding: 1rem;
      border-radius: 6px;
      margin-bottom: 1.5rem;
      border-left: 4px solid #ffc107;
    }

    .trigger-controls h3 {
      color: #1a2332;
      font-size: 1rem;
      margin-bottom: 0.8rem;
    }

    .trigger-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
    }

    .chart-container {
      background: white;
      border-radius: 8px;
      padding: 1.5rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .chart-container canvas {
      width: 100% !important;
      height: 400px !important;
    }

    .info-bar {
      display: flex;
      justify-content: space-between;
      padding: 0.8rem;
      background: #1a2332;
      color: white;
      border-radius: 4px;
      margin-bottom: 1rem;
      font-size: 0.85rem;
    }

    .info-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .info-label {
      color: #8899a6;
    }

    .info-value {
      font-weight: 600;
      color: #2c5aa0;
      background: white;
      padding: 0.2rem 0.5rem;
      border-radius: 3px;
    }

    @media (max-width: 768px) {
      .channel-controls {
        grid-template-columns: 1fr;
      }
      
      .oscilloscope-controls {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>

<div class="card">
  <h2>üî¨ Osciloscopio Digital Mejorado</h2>
  
  <div class="info-bar">
    <div class="info-item">
      <span class="info-label">Escala Tiempo:</span>
      <span class="info-value" id="timeScaleDisplay">500 muestras</span>
    </div>
    <div class="info-item">
      <span class="info-label">CH1 Escala:</span>
      <span class="info-value" id="ch1ScaleDisplay">4095 LSB</span>
    </div>
    <div class="info-item">
      <span class="info-label">CH2 Escala:</span>
      <span class="info-value" id="ch2ScaleDisplay">4095 LSB</span>
    </div>
    <div class="info-item">
      <span class="info-label">Muestras:</span>
      <span class="info-value" id="sampleCountDisplay">0</span>
    </div>
  </div>

  <!-- Controles de Canal -->
  <div class="channel-controls">
    <div class="channel-panel ch1">
      <h3>üìä Canal 1 (Azul)</h3>
      <div class="channel-buttons">
        <button class="btn" onclick="sendCommand('CH1ON')">ON</button>
        <button class="btn btn-danger" onclick="sendCommand('CH1OFF')">OFF</button>
      </div>
      <div class="control-group">
        <label>
          Escala Vertical (V/div)
          <span class="scale-value" id="ch1ScaleValue">4095 LSB</span>
        </label>
        <input type="range" id="ch1Scale" min="100" max="4095" value="4095" step="50">
        <select id="ch1ScalePreset" onchange="applyPresetCh1(this.value)">
          <option value="4095">Escala Completa (0-4095)</option>
          <option value="2048">Media Escala (¬±2048)</option>
          <option value="1024">1/4 Escala (¬±1024)</option>
          <option value="512">1/8 Escala (¬±512)</option>
          <option value="256">1/16 Escala (¬±256)</option>
          <option value="128">1/32 Escala (¬±128)</option>
        </select>
      </div>
      <div class="control-group">
        <label>
          Offset Vertical
          <span class="scale-value" id="ch1OffsetValue">2048</span>
        </label>
        <input type="range" id="ch1Offset" min="0" max="4095" value="2048" step="10">
      </div>
    </div>

    <div class="channel-panel ch2">
      <h3>üìä Canal 2 (Gris)</h3>
      <div class="channel-buttons">
        <button class="btn" onclick="sendCommand('CH2ON')">ON</button>
        <button class="btn btn-danger" onclick="sendCommand('CH2OFF')">OFF</button>
      </div>
      <div class="control-group">
        <label>
          Escala Vertical (V/div)
          <span class="scale-value" id="ch2ScaleValue">4095 LSB</span>
        </label>
        <input type="range" id="ch2Scale" min="100" max="4095" value="4095" step="50">
        <select id="ch2ScalePreset" onchange="applyPresetCh2(this.value)">
          <option value="4095">Escala Completa (0-4095)</option>
          <option value="2048">Media Escala (¬±2048)</option>
          <option value="1024">1/4 Escala (¬±1024)</option>
          <option value="512">1/8 Escala (¬±512)</option>
          <option value="256">1/16 Escala (¬±256)</option>
          <option value="128">1/32 Escala (¬±128)</option>
        </select>
      </div>
      <div class="control-group">
        <label>
          Offset Vertical
          <span class="scale-value" id="ch2OffsetValue">2048</span>
        </label>
        <input type="range" id="ch2Offset" min="0" max="4095" value="2048" step="10">
      </div>
    </div>
  </div>

  <!-- Controles de Tiempo -->
  <div class="oscilloscope-controls">
    <div class="control-group">
      <label>
        ‚è±Ô∏è Escala Horizontal
        <span class="scale-value" id="timescaleValue">500 muestras</span>
      </label>
      <input type="range" id="timescale" min="50" max="1000" value="500" step="50">
      <select id="timescalePreset" onchange="applyTimePreset(this.value)">
        <option value="100">100 muestras (r√°pido)</option>
        <option value="250">250 muestras</option>
        <option value="500" selected>500 muestras</option>
        <option value="750">750 muestras</option>
        <option value="1000">1000 muestras (lento)</option>
      </select>
    </div>

    <div class="control-group">
      <label>üîÑ Modo de Actualizaci√≥n</label>
      <select id="updateMode">
        <option value="continuous">Continuo</option>
        <option value="single" selected>Disparo √önico</option>
      </select>
    </div>

    <div class="control-group">
      <label>üìà Interpolaci√≥n</label>
      <select id="interpolation" onchange="updateInterpolation()">
        <option value="0">Sin interpolaci√≥n</option>
        <option value="0.1" selected>Suave</option>
        <option value="0.3">Muy suave</option>
      </select>
    </div>
  </div>

  <!-- Controles de Trigger -->
  <div class="trigger-controls">
    <h3>‚ö° Trigger</h3>
    <div class="trigger-grid">
      <div class="control-group">
        <label>Canal</label>
        <select id="triggerChannel">
          <option value="none">Deshabilitado</option>
          <option value="ch1">Canal 1</option>
          <option value="ch2">Canal 2</option>
        </select>
      </div>
      <div class="control-group">
        <label>Nivel</label>
        <input id="triggerLevel" type="number" value="2048" min="0" max="4095">
      </div>
      <div class="control-group">
        <label>Modo</label>
        <select id="triggerMode">
          <option value="rising">Flanco Ascendente ‚Üó</option>
          <option value="falling">Flanco Descendente ‚Üò</option>
        </select>
      </div>
      <div class="control-group">
        <label>Acciones</label>
        <button class="btn btn-secondary" onclick="clearADCChart()">Limpiar</button>
      </div>
    </div>
  </div>

  <!-- Gr√°fico -->
  <div class="chart-container">
    <canvas id="chartADC"></canvas>
  </div>
</div>

<script>
// Variables globales
let adcBuffer = { ch1: [], ch2: [] };
let sampleCounter = 0;
let triggerArmed = false;
let triggerTriggered = false;

// Configuraci√≥n de escalas
let ch1Scale = 4095;
let ch1Offset = 2048;
let ch2Scale = 4095;
let ch2Offset = 2048;
let maxSamples = 500;
let updateMode = 'single';
let interpolationTension = 0.1;

// Crear gr√°fico
const chartADC = new Chart(document.getElementById('chartADC'), {
  type: 'line',
  data: {
    labels: [],
    datasets: [
      {
        label: 'Canal 1',
        data: [],
        borderColor: '#2c5aa0',
        backgroundColor: 'rgba(44, 90, 160, 0.1)',
        borderWidth: 2,
        fill: false,
        tension: 0.1,
        pointRadius: 0,
        yAxisID: 'y'
      },
      {
        label: 'Canal 2',
        data: [],
        borderColor: '#6c757d',
        backgroundColor: 'rgba(108, 117, 125, 0.1)',
        borderWidth: 2,
        fill: false,
        tension: 0.1,
        pointRadius: 0,
        yAxisID: 'y1'
      }
    ]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    animation: false,
    interaction: { mode: 'index', intersect: false },
    plugins: { 
      legend: { display: true },
      tooltip: { enabled: true }
    },
    scales: {
      x: {
        title: { display: true, text: 'Muestras' },
        grid: { color: 'rgba(0,0,0,0.05)' }
      },
      y: {
        position: 'left',
        title: { display: true, text: 'Canal 1 (LSB)' },
        min: 0,
        max: 4095,
        grid: { color: 'rgba(44, 90, 160, 0.1)' }
      },
      y1: {
        position: 'right',
        title: { display: true, text: 'Canal 2 (LSB)' },
        min: 0,
        max: 4095,
        grid: { drawOnChartArea: false }
      }
    }
  }
});

// Funci√≥n para actualizar escalas del gr√°fico
function updateChartScales() {
  const ch1Min = Math.max(0, ch1Offset - ch1Scale);
  const ch1Max = Math.min(4095, ch1Offset + ch1Scale);
  const ch2Min = Math.max(0, ch2Offset - ch2Scale);
  const ch2Max = Math.min(4095, ch2Offset + ch2Scale);

  chartADC.options.scales.y.min = ch1Min;
  chartADC.options.scales.y.max = ch1Max;
  chartADC.options.scales.y1.min = ch2Min;
  chartADC.options.scales.y1.max = ch2Max;
  
  chartADC.update('none');
}

// Event listeners para controles
document.getElementById('ch1Scale').addEventListener('input', function(e) {
  ch1Scale = parseInt(e.target.value);
  document.getElementById('ch1ScaleValue').textContent = ch1Scale + ' LSB';
  document.getElementById('ch1ScaleDisplay').textContent = ch1Scale + ' LSB';
  updateChartScales();
});

document.getElementById('ch1Offset').addEventListener('input', function(e) {
  ch1Offset = parseInt(e.target.value);
  document.getElementById('ch1OffsetValue').textContent = ch1Offset;
  updateChartScales();
});

document.getElementById('ch2Scale').addEventListener('input', function(e) {
  ch2Scale = parseInt(e.target.value);
  document.getElementById('ch2ScaleValue').textContent = ch2Scale + ' LSB';
  document.getElementById('ch2ScaleDisplay').textContent = ch2Scale + ' LSB';
  updateChartScales();
});

document.getElementById('ch2Offset').addEventListener('input', function(e) {
  ch2Offset = parseInt(e.target.value);
  document.getElementById('ch2OffsetValue').textContent = ch2Offset;
  updateChartScales();
});

document.getElementById('timescale').addEventListener('input', function(e) {
  maxSamples = parseInt(e.target.value);
  document.getElementById('timescaleValue').textContent = maxSamples + ' muestras';
  document.getElementById('timeScaleDisplay').textContent = maxSamples + ' muestras';
});

document.getElementById('updateMode').addEventListener('change', function(e) {
  updateMode = e.target.value;
});

function updateInterpolation() {
  interpolationTension = parseFloat(document.getElementById('interpolation').value);
  chartADC.data.datasets[0].tension = interpolationTension;
  chartADC.data.datasets[1].tension = interpolationTension;
  chartADC.update('none');
}

function applyPresetCh1(value) {
  const scale = parseInt(value);
  document.getElementById('ch1Scale').value = scale;
  ch1Scale = scale;
  document.getElementById('ch1ScaleValue').textContent = scale + ' LSB';
  document.getElementById('ch1ScaleDisplay').textContent = scale + ' LSB';
  updateChartScales();
}

function applyPresetCh2(value) {
  const scale = parseInt(value);
  document.getElementById('ch2Scale').value = scale;
  ch2Scale = scale;
  document.getElementById('ch2ScaleValue').textContent = scale + ' LSB';
  document.getElementById('ch2ScaleDisplay').textContent = scale + ' LSB';
  updateChartScales();
}

function applyTimePreset(value) {
  const samples = parseInt(value);
  document.getElementById('timescale').value = samples;
  maxSamples = samples;
  document.getElementById('timescaleValue').textContent = samples + ' muestras';
  document.getElementById('timeScaleDisplay').textContent = samples + ' muestras';
}

// Simular datos ADC (para demostraci√≥n)
function parseADCData(data) {
  const match = data.match(/CH1:(\d+),CH2:(\d+)/);
  if (!match) return;

  const ch1 = parseInt(match[1]);
  const ch2 = parseInt(match[2]);

  adcBuffer.ch1.push(ch1);
  adcBuffer.ch2.push(ch2);
  sampleCounter++;
  
  document.getElementById('sampleCountDisplay').textContent = sampleCounter;

  const triggerChannel = document.getElementById('triggerChannel').value;
  const triggerLevel = parseInt(document.getElementById('triggerLevel').value);
  const triggerMode = document.getElementById('triggerMode').value;

  let triggerValue = (triggerChannel === 'ch1') ? ch1 : (triggerChannel === 'ch2') ? ch2 : null;

  if (triggerChannel !== 'none' && triggerValue !== null) {
    if (!triggerArmed) {
      if (triggerMode === 'rising' && triggerValue > triggerLevel) {
        triggerArmed = true;
        triggerTriggered = false;
      } else if (triggerMode === 'falling' && triggerValue < triggerLevel) {
        triggerArmed = true;
        triggerTriggered = false;
      }
    } else if (!triggerTriggered) {
      if (triggerMode === 'rising' && triggerValue <= triggerLevel) {
        triggerTriggered = true;
      } else if (triggerMode === 'falling' && triggerValue >= triggerLevel) {
        triggerTriggered = true;
      }
    }
  } else {
    triggerArmed = true;
    triggerTriggered = true;
  }

  const shouldUpdate = updateMode === 'continuous' || 
                      (adcBuffer.ch1.length >= maxSamples && triggerTriggered);

  if (shouldUpdate) {
    updateADCChart();
    if (updateMode === 'single') {
      adcBuffer.ch1 = [];
      adcBuffer.ch2 = [];
      sampleCounter = 0;
      triggerArmed = false;
      triggerTriggered = false;
    }
  }
}

function updateADCChart() {
  const dataLength = Math.min(adcBuffer.ch1.length, maxSamples);
  const startIdx = Math.max(0, adcBuffer.ch1.length - maxSamples);
  
  chartADC.data.labels = [];
  for (let i = 0; i < dataLength; i++) {
    chartADC.data.labels.push(i.toString());
  }
  
  chartADC.data.datasets[0].data = adcBuffer.ch1.slice(startIdx);
  chartADC.data.datasets[1].data = adcBuffer.ch2.slice(startIdx);
  chartADC.update('none');
}

function clearADCChart() {
  chartADC.data.labels = [];
  chartADC.data.datasets[0].data = [];
  chartADC.data.datasets[1].data = [];
  chartADC.update('none');
  adcBuffer.ch1 = [];
  adcBuffer.ch2 = [];
  sampleCounter = 0;
  triggerArmed = false;
  triggerTriggered = false;
  document.getElementById('sampleCountDisplay').textContent = '0';
}

function sendCommand(cmd) {
  console.log('Comando enviado:', cmd);
  // Aqu√≠ conectar con tu sistema real
}

// Simulaci√≥n de datos para prueba
function simulateData() {
  const t = Date.now() / 100;
  const ch1 = 2048 + Math.sin(t) * 200 + Math.random() * 50;
  const ch2 = 2048 + Math.cos(t * 1.5) * 500 + Math.random() * 30;
  parseADCData(`CH1:${Math.round(ch1)},CH2:${Math.round(ch2)}`);
}

// Iniciar simulaci√≥n (comentar esto cuando conectes con datos reales)
setInterval(simulateData, 10);

console.log('‚úÖ Osciloscopio mejorado inicializado');
</script>

</body>
</html>
