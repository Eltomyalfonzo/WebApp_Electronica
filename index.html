<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FRA Monitor - UTN FRSF</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Roboto', sans-serif;
      background: #f5f7fa;
      color: #2c3e50;
      min-height: 100vh;
    }

    .navbar {
      background: #1a2332;
      padding: 1rem 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      border-bottom: 3px solid #2c5aa0;
    }

    .navbar-brand {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .logo-utn {
      width: 50px;
      height: 50px;
      background: white;
      border-radius: 4px;
      padding: 4px;
    }

    .navbar h1 {
      font-size: 1.5rem;
      font-weight: 500;
      color: white;
      letter-spacing: 0.5px;
    }

    .navbar-actions button {
      background: #2c5aa0;
      color: white;
      border: none;
      padding: 0.6rem 1.2rem;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
      font-size: 0.9rem;
      transition: all 0.3s ease;
    }

    .navbar-actions button:hover {
      background: #3d6fb8;
      box-shadow: 0 2px 8px rgba(44, 90, 160, 0.3);
    }

    .sidebar {
      position: fixed;
      left: 0;
      top: 76px;
      width: 250px;
      height: calc(100vh - 76px);
      background: white;
      border-right: 1px solid #e1e8ed;
      padding: 1.5rem 0;
      overflow-y: auto;
      box-shadow: 2px 0 8px rgba(0, 0, 0, 0.05);
    }

    .sidebar h3 {
      padding: 0 1.5rem;
      color: #1a2332;
      font-size: 0.9rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 1rem;
    }

    .menu-item {
      padding: 0.9rem 1.5rem;
      cursor: pointer;
      transition: all 0.2s ease;
      color: #5a6c7d;
      font-weight: 400;
      border-left: 3px solid transparent;
    }

    .menu-item:hover {
      background: #f8f9fa;
      color: #2c5aa0;
      border-left-color: #2c5aa0;
    }

    .menu-item.active {
      background: #e8f0f8;
      color: #2c5aa0;
      border-left-color: #2c5aa0;
      font-weight: 500;
    }

    .main-content {
      margin-left: 250px;
      padding: 2rem;
      min-height: calc(100vh - 76px);
    }

    .content-section {
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .content-section.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .card {
      background: white;
      border-radius: 8px;
      padding: 1.5rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      margin-bottom: 1.5rem;
    }

    .card h2 {
      color: #1a2332;
      font-size: 1.3rem;
      font-weight: 500;
      margin-bottom: 1rem;
      padding-bottom: 0.8rem;
      border-bottom: 2px solid #e1e8ed;
    }

    .card p {
      line-height: 1.6;
      color: #5a6c7d;
      margin-bottom: 0.8rem;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
      margin-top: 1.5rem;
    }

    .info-item {
      background: #f8f9fa;
      padding: 1rem;
      border-radius: 6px;
      border-left: 3px solid #2c5aa0;
    }

    .info-item h4 {
      color: #1a2332;
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .info-item p {
      color: #5a6c7d;
      font-size: 0.9rem;
      margin: 0;
    }

    .charts-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .chart-container {
      background: white;
      border-radius: 8px;
      padding: 1.5rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .chart-container h3 {
      color: #1a2332;
      font-size: 1.1rem;
      font-weight: 500;
      margin-bottom: 1rem;
    }

    .chart-container canvas {
      width: 100% !important;
      height: 300px !important;
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-group label {
      display: block;
      color: #1a2332;
      font-weight: 500;
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
    }

    .form-control {
      width: 100%;
      padding: 0.7rem;
      border: 1px solid #d1d9e0;
      border-radius: 4px;
      font-family: 'Roboto', sans-serif;
      font-size: 0.9rem;
      transition: border-color 0.2s ease;
    }

    .form-control:focus {
      outline: none;
      border-color: #2c5aa0;
      box-shadow: 0 0 0 3px rgba(44, 90, 160, 0.1);
    }

    .form-inline {
      display: flex;
      gap: 1rem;
      align-items: flex-end;
      flex-wrap: wrap;
    }

    .form-inline .form-group {
      flex: 1;
      min-width: 200px;
      margin-bottom: 0;
    }

    .btn {
      background: #2c5aa0;
      color: white;
      border: none;
      padding: 0.7rem 1.5rem;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
      font-size: 0.9rem;
      transition: all 0.3s ease;
    }

    .btn:hover {
      background: #3d6fb8;
      box-shadow: 0 2px 8px rgba(44, 90, 160, 0.3);
    }

    .btn-secondary {
      background: #6c757d;
    }

    .btn-secondary:hover {
      background: #5a6268;
    }

    .btn-danger {
      background: #dc3545;
    }

    .btn-danger:hover {
      background: #c82333;
    }

    .console-box {
      background: #1a2332;
      border: 1px solid #2c3e50;
      border-radius: 4px;
      padding: 1rem;
      height: 150px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 0.85rem;
      color: #a8b8cc;
      line-height: 1.5;
    }

    /* ESTILOS MEJORADOS PARA OSCILOSCOPIO */
    .info-bar {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      padding: 0.8rem;
      background: #1a2332;
      color: white;
      border-radius: 4px;
      margin-bottom: 1rem;
      font-size: 0.85rem;
      gap: 1rem;
    }

    .info-bar-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .info-label {
      color: #8899a6;
    }

    .info-value {
      font-weight: 600;
      color: #2c5aa0;
      background: white;
      padding: 0.2rem 0.5rem;
      border-radius: 3px;
    }

    .channel-controls {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .channel-panel {
      background: #f8f9fa;
      padding: 1rem;
      border-radius: 6px;
      border-left: 4px solid #2c5aa0;
    }

    .channel-panel.ch2 {
      border-left-color: #6c757d;
    }

    .channel-panel h3 {
      color: #1a2332;
      font-size: 1rem;
      margin-bottom: 0.8rem;
    }

    .channel-buttons {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.8rem;
    }

    .channel-buttons .btn {
      flex: 1;
      padding: 0.6rem 1rem;
      font-size: 0.85rem;
    }

    .control-group {
      margin-bottom: 0.8rem;
    }

    .control-group label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: #1a2332;
      font-weight: 500;
      font-size: 0.85rem;
      margin-bottom: 0.4rem;
    }

    .scale-value {
      color: #2c5aa0;
      font-weight: 600;
      font-size: 0.9rem;
    }

    .control-group select,
    .control-group input[type="range"],
    .control-group input[type="number"] {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid #d1d9e0;
      border-radius: 4px;
      font-family: 'Roboto', sans-serif;
      font-size: 0.85rem;
    }

    .control-group input[type="range"] {
      cursor: pointer;
    }

    .oscilloscope-controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
      background: #f8f9fa;
      padding: 1rem;
      border-radius: 6px;
    }

    .trigger-controls {
      background: #f8f9fa;
      padding: 1rem;
      border-radius: 6px;
      margin-bottom: 1.5rem;
      border-left: 4px solid #ffc107;
    }

    .trigger-controls h3 {
      color: #1a2332;
      font-size: 1rem;
      margin-bottom: 0.8rem;
    }

    .trigger-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
    }

    .adc-controls {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .full-width-chart {
      grid-column: 1 / -1;
    }

    .download-options {
      display: flex;
      gap: 1rem;
      margin-top: 1rem;
    }

    @media (max-width: 1024px) {
      .sidebar {
        transform: translateX(-100%);
        z-index: 1000;
      }

      .sidebar.mobile-open {
        transform: translateX(0);
      }

      .main-content {
        margin-left: 0;
      }

      .charts-grid {
        grid-template-columns: 1fr;
      }

      .channel-controls {
        grid-template-columns: 1fr;
      }

      .adc-controls {
        grid-template-columns: 1fr 1fr;
      }
    }

    @media (max-width: 768px) {
      .navbar {
        flex-direction: column;
        gap: 1rem;
      }

      .form-inline {
        flex-direction: column;
      }

      .form-inline .form-group {
        width: 100%;
      }

      .adc-controls {
        grid-template-columns: 1fr;
      }

      .info-bar {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>

<div class="navbar">
  <div class="navbar-brand">
    <svg class="logo-utn" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
      <rect width="100" height="100" fill="#1a2332"/>
      <text x="50" y="55" font-family="Arial, sans-serif" font-size="40" font-weight="bold" fill="white" text-anchor="middle">UTN</text>
      <text x="50" y="75" font-family="Arial, sans-serif" font-size="12" fill="#2c5aa0" text-anchor="middle">FRSF</text>
    </svg>
    <div>
      <h1>FRA Monitor</h1>
      <p style="font-size: 0.8rem; color: #8899a6; margin: 0;">Analizador de Respuesta en Frecuencia</p>
    </div>
  </div>
  <div class="navbar-actions">
    <button id="downloadAllBtn">Descargar Gr√°ficos</button>
  </div>
</div>

<div class="sidebar">
  <h3>Herramientas</h3>
  <div class="menu-item active" data-section="inicio">Inicio</div>
  <div class="menu-item" data-section="bode">Diagrama de Bode</div>
  <div class="menu-item" data-section="nyquist">Diagrama de Nyquist</div>
  <div class="menu-item" data-section="osciloscopio">Osciloscopio</div>
  <div class="menu-item" data-section="conexion">Conexi√≥n y Control</div>
</div>

<div class="main-content">
  <!-- SECCI√ìN INICIO -->
  <div class="content-section active" id="inicio">
    <div class="card">
      <h2>Bienvenido al FRA Monitor</h2>
      <p>Sistema de monitoreo y an√°lisis de respuesta en frecuencia para dispositivos embebidos, desarrollado en la <strong>Universidad Tecnol√≥gica Nacional - Facultad Regional San Francisco</strong>.</p>
      
      <div class="info-grid">
        <div class="info-item">
          <h4>An√°lisis de Bode</h4>
          <p>Visualiza la magnitud y fase de la respuesta en frecuencia del sistema bajo prueba.</p>
        </div>
        <div class="info-item">
          <h4>Diagrama de Nyquist</h4>
          <p>Representa la respuesta en frecuencia en el plano complejo para an√°lisis de estabilidad.</p>
        </div>
        <div class="info-item">
          <h4>Osciloscopio Digital</h4>
          <p>Captura y visualiza se√±ales anal√≥gicas de dos canales en tiempo real con trigger configurable.</p>
        </div>
        <div class="info-item">
          <h4>Conexi√≥n MQTT</h4>
          <p>Comunicaci√≥n en tiempo real con dispositivos ESP32 a trav√©s de protocolo MQTT.</p>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Descripci√≥n del Proyecto</h2>
      <p>El FRA Monitor es una herramienta de an√°lisis de sistemas de control y circuitos electr√≥nicos que permite caracterizar la respuesta en frecuencia de forma remota. Utiliza tecnolog√≠a web moderna para proporcionar una interfaz intuitiva y profesional.</p>
      
      <p><strong>Caracter√≠sticas principales:</strong></p>
      <ul style="padding-left: 1.5rem; line-height: 1.8; color: #5a6c7d;">
        <li>An√°lisis de respuesta en frecuencia (Bode y Nyquist)</li>
        <li>Osciloscopio digital de dos canales con trigger</li>
        <li>Comunicaci√≥n MQTT con dispositivos ESP32</li>
        <li>Exportaci√≥n de datos en formato PNG y CSV</li>
        <li>Interfaz web responsive y profesional</li>
      </ul>
    </div>
  </div>

  <!-- SECCI√ìN BODE -->
  <div class="content-section" id="bode">
    <div class="card">
      <h2>Diagrama de Bode</h2>
      <div class="charts-grid">
        <div class="chart-container">
          <h3>Magnitud [dB]</h3>
          <canvas id="chartMag"></canvas>
          <div class="download-options">
            <button class="btn btn-secondary" data-action="download-mag-png">Descargar PNG</button>
            <button class="btn btn-secondary" data-action="download-mag-csv">Descargar CSV</button>
          </div>
        </div>
        <div class="chart-container">
          <h3>Fase [rad]</h3>
          <canvas id="chartPhase"></canvas>
          <div class="download-options">
            <button class="btn btn-secondary" data-action="download-phase-png">Descargar PNG</button>
            <button class="btn btn-secondary" data-action="download-phase-csv">Descargar CSV</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- SECCI√ìN NYQUIST -->
  <div class="content-section" id="nyquist">
    <div class="card">
      <h2>Diagrama de Nyquist</h2>
      <div class="chart-container full-width-chart">
        <canvas id="chartNyquist"></canvas>
        <div class="download-options">
          <button class="btn btn-secondary" data-action="download-nyquist-png">Descargar PNG</button>
          <button class="btn btn-secondary" data-action="download-nyquist-csv">Descargar CSV</button>
        </div>
      </div>
    </div>
  </div>

  <!-- SECCI√ìN OSCILOSCOPIO MEJORADO -->
  <div class="content-section" id="osciloscopio">
    <div class="card">
      <h2>üî¨ Osciloscopio Digital</h2>
      
      <div class="info-bar">
        <div class="info-bar-item">
          <span class="info-label">Escala Tiempo:</span>
          <span class="info-value" id="timeScaleDisplay">500 muestras</span>
        </div>
        <div class="info-bar-item">
          <span class="info-label">CH1 Escala:</span>
          <span class="info-value" id="ch1ScaleDisplay">4095 LSB</span>
        </div>
        <div class="info-bar-item">
          <span class="info-label">CH2 Escala:</span>
          <span class="info-value" id="ch2ScaleDisplay">4095 LSB</span>
        </div>
        <div class="info-bar-item">
          <span class="info-label">Muestras:</span>
          <span class="info-value" id="sampleCountDisplay">0</span>
        </div>
      </div>

      <!-- Controles de Canal -->
      <div class="channel-controls">
        <div class="channel-panel ch1">
          <h3>üìä Canal 1 (Azul)</h3>
          <div class="channel-buttons">
            <button class="btn" data-cmd="CH1ON">ON</button>
            <button class="btn btn-danger" data-cmd="CH1OFF">OFF</button>
          </div>
          <div class="control-group">
            <label>
              <span>Escala Vertical (V/div)</span>
              <span class="scale-value" id="ch1ScaleValue">4095 LSB</span>
            </label>
            <input type="range" id="ch1Scale" min="100" max="4095" value="4095" step="50">
            <select id="ch1ScalePreset">
              <option value="4095">Escala Completa (0-4095)</option>
              <option value="2048">Media Escala (¬±2048)</option>
              <option value="1024">1/4 Escala (¬±1024)</option>
              <option value="512">1/8 Escala (¬±512)</option>
              <option value="256">1/16 Escala (¬±256)</option>
              <option value="128">1/32 Escala (¬±128)</option>
            </select>
          </div>
          <div class="control-group">
            <label>
              <span>Offset Vertical</span>
              <span class="scale-value" id="ch1OffsetValue">2048</span>
            </label>
            <input type="range" id="ch1Offset" min="0" max="4095" value="2048" step="10">
          </div>
        </div>

        <div class="channel-panel ch2">
          <h3>üìä Canal 2 (Gris)</h3>
          <div class="channel-buttons">
            <button class="btn" data-cmd="CH2ON">ON</button>
            <button class="btn btn-danger" data-cmd="CH2OFF">OFF</button>
          </div>
          <div class="control-group">
            <label>
              <span>Escala Vertical (V/div)</span>
              <span class="scale-value" id="ch2ScaleValue">4095 LSB</span>
            </label>
            <input type="range" id="ch2Scale" min="100" max="4095" value="4095" step="50">
            <select id="ch2ScalePreset">
              <option value="4095">Escala Completa (0-4095)</option>
              <option value="2048">Media Escala (¬±2048)</option>
              <option value="1024">1/4 Escala (¬±1024)</option>
              <option value="512">1/8 Escala (¬±512)</option>
              <option value="256">1/16 Escala (¬±256)</option>
              <option value="128">1/32 Escala (¬±128)</option>
            </select>
          </div>
          <div class="control-group">
            <label>
              <span>Offset Vertical</span>
              <span class="scale-value" id="ch2OffsetValue">2048</span>
            </label>
            <input type="range" id="ch2Offset" min="0" max="4095" value="2048" step="10">
          </div>
        </div>
      </div>

      <!-- Controles de Tiempo -->
      <div class="oscilloscope-controls">
        <div class="control-group">
          <label>
            <span>‚è±Ô∏è Escala Horizontal</span>
            <span class="scale-value" id="timescaleValue">500 muestras</span>
          </label>
          <input type="range" id="timescale" min="50" max="1000" value="500" step="50">
          <select id="timescalePreset">
            <option value="100">100 muestras (r√°pido)</option>
            <option value="250">250 muestras</option>
            <option value="500" selected>500 muestras</option>
            <option value="750">750 muestras</option>
            <option value="1000">1000 muestras (lento)</option>
          </select>
        </div>

        <div class="control-group">
          <label>üîÑ Modo de Actualizaci√≥n</label>
          <select id="updateMode">
            <option value="continuous">Continuo</option>
            <option value="single" selected>Disparo √önico</option>
          </select>
        </div>

        <div class="control-group">
          <label>üìà Interpolaci√≥n</label>
          <select id="interpolation">
            <option value="0">Sin interpolaci√≥n</option>
            <option value="0.1" selected>Suave</option>
            <option value="0.3">Muy suave</option>
          </select>
        </div>
      </div>

      <!-- Controles de Trigger -->
      <div class="trigger-controls">
        <h3>‚ö° Trigger</h3>
        <div class="trigger-grid">
          <div class="control-group">
            <label>Canal</label>
            <select id="triggerChannel">
              <option value="none">Deshabilitado</option>
              <option value="ch1">Canal 1</option>
              <option value="ch2">Canal 2</option>
            </select>
          </div>
          <div class="control-group">
            <label>Nivel</label>
            <input id="triggerLevel" type="number" value="2048" min="0" max="4095">
          </div>
          <div class="control-group">
            <label>Modo</label>
            <select id="triggerMode">
              <option value="rising">Flanco Ascendente ‚Üó</option>
              <option value="falling">Flanco Descendente ‚Üò</option>
            </select>
          </div>
          <div class="control-group">
            <label>Acciones</label>
            <button class="btn btn-secondary" id="clearADCBtn">Limpiar</button>
          </div>
        </div>
      </div>

      <div class="chart-container">
        <canvas id="chartADC"></canvas>
        <div class="download-options">
          <button class="btn btn-secondary" data-action="download-adc-png">Descargar PNG</button>
        </div>
      </div>
    </div>
  </div>

  <!-- SECCI√ìN CONEXI√ìN -->
  <div class="content-section" id="conexion">
    <div class="card">
      <h2>Conexi√≥n y Control</h2>
      <form id="commandForm">
        <div class="form-inline">
          <div class="form-group">
            <label>ID del Dispositivo</label>
            <input id="deviceId" type="text" class="form-control" placeholder="ESP32_A1" required>
          </div>
          <button type="button" class="btn" id="connectBtn">Conectar</button>
        </div>

        <div class="form-inline" style="margin-top: 1rem;">
          <div class="form-group">
            <label>Comando</label>
            <input id="inputData" type="text" class="form-control" placeholder="-10;1000A o 1.57;1000F o S1000">
          </div>
          <button type="submit" class="btn">Enviar</button>
        </div>
      </form>
      
      <div class="form-group" style="margin-top: 1.5rem;">
        <label>Consola</label>
        <pre id="log" class="console-box"></pre>
      </div>
    </div>
  </div>
</div>

<script>
// Cargar Socket.IO din√°micamente
function loadSocketIO() {
  return new Promise((resolve, reject) => {
    const script1 = document.createElement('script');
    script1.src = '/socket.io/socket.io.js';
    script1.onload = () => {
      console.log('‚úÖ Socket.IO cargado desde servidor');
      resolve();
    };
    script1.onerror = () => {
      console.log('‚ö†Ô∏è No se pudo cargar desde servidor, intentando CDN...');
      const script2 = document.createElement('script');
      script2.src = 'https://cdn.socket.io/4.7.2/socket.io.min.js';
      script2.crossOrigin = 'anonymous';
      script2.onload = () => {
        console.log('‚úÖ Socket.IO cargado desde CDN');
        resolve();
      };
      script2.onerror = () => {
        console.error('‚ùå No se pudo cargar Socket.IO');
        reject(new Error('Socket.IO no disponible'));
      };
