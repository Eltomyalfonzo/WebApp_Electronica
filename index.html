<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FRA_Monitor</title>
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #1a1a1a;
    }

    .navbar {
      background: rgba(15, 23, 42, 0.95);
      backdrop-filter: blur(10px);
      padding: 1.2rem 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      border-bottom: 2px solid #667eea;
    }

    .navbar h1 {
      font-size: 1.8rem;
      font-weight: 700;
      background: linear-gradient(135deg, #667eea, #764ba2);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      letter-spacing: 1px;
    }

    .navbar button {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
      padding: 0.7rem 1.5rem;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    .navbar button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }

    .container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
      padding: 2rem;
      max-width: 1400px;
      margin: 0 auto;
    }

    .chart-card {
      background: white;
      border-radius: 16px;
      padding: 1.5rem;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }

    .chart-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 48px rgba(0, 0, 0, 0.15);
    }

    .chart-card h3 {
      color: #667eea;
      font-size: 1.1rem;
      margin-bottom: 1rem;
      font-weight: 600;
    }

    canvas {
      width: 100% !important;
      height: 300px !important;
      display: block;
    }

    .nyquist-section {
      grid-column: 1 / -1;
      background: white;
      border-radius: 16px;
      padding: 1.5rem;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .nyquist-section h3 {
      color: #667eea;
      font-size: 1.1rem;
      margin-bottom: 1rem;
      font-weight: 600;
    }

    .form-section {
      grid-column: 1 / -1;
      background: white;
      border-radius: 16px;
      padding: 2rem;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    form {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    input[type="text"],
    input[type="number"],
    select {
      padding: 0.7rem 1rem;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-family: 'Inter', sans-serif;
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    input[type="text"]:focus,
    input[type="number"]:focus,
    select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    button[type="button"],
    button[type="submit"],
    button {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
      padding: 0.7rem 1.5rem;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      font-family: 'Inter', sans-serif;
      font-size: 1rem;
    }

    button[type="button"]:hover,
    button[type="submit"]:hover,
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    #log {
      background: #f5f5f5;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 1rem;
      height: 150px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
      color: #333;
      line-height: 1.5;
    }

    .sweep-section {
      grid-column: 1 / -1;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
      border: 2px solid #667eea;
      border-radius: 16px;
      padding: 2rem;
    }

    .sweep-section h3 {
      color: #667eea;
      margin-bottom: 1.5rem;
      font-size: 1.3rem;
    }

    .sweep-controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .sweep-controls label {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      font-weight: 600;
      color: #333;
    }

    .sweep-controls input {
      padding: 0.7rem;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1rem;
    }

    .sweep-buttons {
      display: flex;
      gap: 1rem;
      justify-content: center;
    }

    .sweep-buttons button {
      padding: 0.9rem 2rem;
      font-size: 1rem;
      font-weight: 600;
    }

    .stop-btn {
      background: linear-gradient(135deg, #f093fb, #f5576c) !important;
    }

    .stop-btn:hover {
      box-shadow: 0 6px 20px rgba(245, 87, 108, 0.4) !important;
    }

    .adc-controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .adc-controls button {
      padding: 0.9rem 1.5rem;
      font-weight: 600;
      font-size: 0.95rem;
    }

    .adc-trigger-controls {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
      align-items: center;
    }

    .adc-trigger-controls label {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      font-weight: 600;
      color: #333;
    }

    .adc-trigger-controls select,
    .adc-trigger-controls input {
      padding: 0.5rem;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 0.9rem;
      font-family: 'Inter', sans-serif;
    }

    @media (max-width: 1024px) {
      .container {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 768px) {
      .navbar {
        flex-direction: column;
        gap: 1rem;
      }

      .navbar h1 {
        font-size: 1.4rem;
      }

      .container {
        padding: 1rem;
        gap: 1rem;
      }

      form {
        flex-direction: column;
      }

      input[type="text"],
      input[type="number"],
      button {
        width: 100%;
      }

      .sweep-controls {
        grid-template-columns: 1fr;
      }

      .adc-controls {
        grid-template-columns: 1fr 1fr;
      }

      .adc-trigger-controls {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>

<div class="navbar">
  <h1>‚ö° FRA_Monitor</h1>
  <button onclick="downloadAllCharts()">üì• Descargar Gr√°ficos</button>
</div>

<div class="container">
  <!-- Magnitude Chart -->
  <div class="chart-card">
    <h3>üìä Magnitud [dB]</h3>
    <canvas id="chartMag"></canvas>
  </div>

  <!-- Phase Chart -->
  <div class="chart-card">
    <h3>üìê Fase [rad]</h3>
    <canvas id="chartPhase"></canvas>
  </div>

  <!-- Nyquist Plot -->
  <div class="nyquist-section">
    <h3>üîÑ Diagrama de Nyquist</h3>
    <canvas id="chartNyquist"></canvas>
  </div>

  <!-- Connection & Command Form -->
  <div class="form-section">
    <h3>üîå Conexi√≥n y Control - FRA</h3>
    <form onsubmit="sendData(event)">
      <input id="deviceId" type="text" placeholder="ID del dispositivo (ej: ESP32_A1)" required>
      <button type="button" onclick="connectDevice()">Conectar</button>
      <input id="inputData" type="text" placeholder="-10;1000A o 1.57;1000F o S1000">
      <button type="submit">Enviar</button>
    </form>
    
    <h4 style="color: #667eea; margin-bottom: 1rem; font-size: 0.9rem;">üìã Consola:</h4>
    <pre id="log"></pre>
  </div>

  <!-- ADC Channel Controls -->
  <div class="form-section">
    <h3>üìä Control de Canales ADC</h3>
    <div class="adc-controls">
      <button onclick="sendCommand('CH1ON')" style="background: linear-gradient(135deg, #667eea, #764ba2);">‚úÖ CH1 ON</button>
      <button onclick="sendCommand('CH1OFF')" style="background: linear-gradient(135deg, #f093fb, #f5576c);">‚ùå CH1 OFF</button>
      <button onclick="sendCommand('CH2ON')" style="background: linear-gradient(135deg, #667eea, #764ba2);">‚úÖ CH2 ON</button>
      <button onclick="sendCommand('CH2OFF')" style="background: linear-gradient(135deg, #f093fb, #f5576c);">‚ùå CH2 OFF</button>
    </div>
  </div>

  <!-- ADC Chart with Trigger Controls -->
  <div class="form-section">
    <h3>üìà Osciloscopio - ADC Dual Channel</h3>
    <div class="adc-trigger-controls">
      <label>
        Trigger:
        <select id="triggerChannel">
          <option value="none">Deshabilitado</option>
          <option value="ch1">Canal 1</option>
          <option value="ch2">Canal 2</option>
        </select>
      </label>
      <label>
        Nivel: 
        <input id="triggerLevel" type="number" value="2048" min="0" max="4095">
      </label>
      <label>
        Modo: 
        <select id="triggerMode">
          <option value="rising">Flanco Ascendente</option>
          <option value="falling">Flanco Descendente</option>
        </select>
      </label>
      <button onclick="clearADCChart()" style="background: linear-gradient(135deg, #f093fb, #f5576c);">üóëÔ∏è Limpiar</button>
    </div>
    <canvas id="chartADC"></canvas>
  </div>

  <!-- Automatic Frequency Sweep -->
  <div class="sweep-section">
    <h3>‚öôÔ∏è Barrido de Frecuencia Autom√°tico</h3>
    <div class="sweep-controls">
      <label>
        Inicio [Hz]:
        <input id="startFreq" type="number" value="100" step="1" min="1">
      </label>
      <label>
        Fin [Hz]:
        <input id="endFreq" type="number" value="1000" step="1" min="1">
      </label>
      <label>
        Paso [Hz]:
        <input id="stepFreq" type="number" value="100" step="1" min="1">
      </label>
      <label>
        Espera [s]:
        <input id="waitTime" type="number" value="1" step="0.1" min="0.1">
      </label>
    </div>
    <div class="sweep-buttons">
      <button onclick="startSweep()">‚ñ∂Ô∏è Iniciar Barrido</button>
      <button onclick="stopSweep()" class="stop-btn">‚èπÔ∏è Detener</button>
    </div>
  </div>
</div>

<script>
const socket = io();
let currentDevice = null;

function connectDevice() {
  const id = document.getElementById("deviceId").value.trim();
  if (!id) return log("‚ö†Ô∏è Ingrese un ID de dispositivo.");
  currentDevice = id;
  socket.emit("join_device", id);
  socket.emit("connect_device", id);
  log(`üì° Intentando conectar con ${id}...`);
}

socket.on("update_data", ({ deviceId, payload }) => {
  if (!currentDevice || deviceId !== currentDevice) return;
  if (typeof payload === "string") parsePlot(payload);
  else if (payload.msg) parsePlot(payload.msg);
});

// Recibir datos ADC
socket.on("adc_data", ({ deviceId, data }) => {
  if (!currentDevice || deviceId !== currentDevice) return;
  parseADCData(data);
});

function sendData(e) {
  e.preventDefault();
  const v = document.getElementById("inputData").value.trim();
  const id = document.getElementById("deviceId").value.trim();
  if (!v || !id) return;
  socket.emit("send_command", { deviceId: id, command: v });
  log(`üì§ Enviado a ${id}: ${v}`);
  document.getElementById("inputData").value = "";
}

function sendCommand(cmd) {
  const id = document.getElementById("deviceId").value.trim();
  if (!id) {
    log("‚ö†Ô∏è Conecta primero a un dispositivo");
    return;
  }
  socket.emit("send_command", { deviceId: id, command: cmd });
  log(`üì§ Comando: ${cmd}`);
}

function log(msg) {
  const logEl = document.getElementById("log");
  logEl.textContent += msg + "\n";
  logEl.scrollTop = logEl.scrollHeight;
}

// Charts Configuration
Chart.defaults.font.family = 'Inter';
Chart.defaults.font.size = 14;
Chart.defaults.color = '#666';

const chartMag = new Chart(document.getElementById('chartMag'), {
  type: 'line',
  data: {
    labels: [],
    datasets: [{
      label: 'Magnitud [dB]',
      data: [],
      borderColor: '#667eea',
      backgroundColor: 'rgba(102, 126, 234, 0.1)',
      borderWidth: 2.5,
      fill: true,
      tension: 0.4,
      pointRadius: 4,
      pointBackgroundColor: '#667eea',
      pointBorderColor: 'white',
      pointBorderWidth: 2
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: { display: true, labels: { usePointStyle: true, padding: 15 } }
    },
    scales: {
      x: {
        type: 'logarithmic',
        title: { display: true, text: 'Frecuencia [rad/s]', font: { size: 14, weight: 600 } },
        grid: { color: 'rgba(0,0,0,0.05)' }
      },
      y: {
        title: { display: true, text: 'Magnitud [dB]', font: { size: 14, weight: 600 } },
        grid: { color: 'rgba(0,0,0,0.05)' }
      }
    }
  }
});

const chartPhase = new Chart(document.getElementById('chartPhase'), {
  type: 'line',
  data: {
    labels: [],
    datasets: [{
      label: 'Fase [rad]',
      data: [],
      borderColor: '#f5576c',
      backgroundColor: 'rgba(245, 87, 108, 0.1)',
      borderWidth: 2.5,
      fill: true,
      tension: 0.4,
      pointRadius: 4,
      pointBackgroundColor: '#f5576c',
      pointBorderColor: 'white',
      pointBorderWidth: 2
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: { display: true, labels: { usePointStyle: true, padding: 15 } }
    },
    scales: {
      x: {
        type: 'logarithmic',
        title: { display: true, text: 'Frecuencia [rad/s]', font: { size: 14, weight: 600 } },
        grid: { color: 'rgba(0,0,0,0.05)' }
      },
      y: {
        title: { display: true, text: 'Fase [rad]', font: { size: 14, weight: 600 } },
        grid: { color: 'rgba(0,0,0,0.05)' }
      }
    }
  }
});

const chartNyquist = new Chart(document.getElementById('chartNyquist'), {
  type: 'scatter',
  data: {
    datasets: [{
      label: 'Nyquist',
      data: [],
      borderColor: '#764ba2',
      backgroundColor: 'rgba(118, 75, 162, 0.5)',
      borderWidth: 2.5,
      pointRadius: 5,
      pointBackgroundColor: '#764ba2',
      showLine: true,
      fill: false,
      tension: 0.3
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: { display: true, labels: { usePointStyle: true, padding: 15 } }
    },
    scales: {
      x: {
        title: { display: true, text: 'Re', font: { size: 14, weight: 600 } },
        grid: { color: 'rgba(0,0,0,0.05)' }
      },
      y: {
        title: { display: true, text: 'Im', font: { size: 14, weight: 600 } },
        grid: { color: 'rgba(0,0,0,0.05)' }
      }
    }
  }
});

// ADC Chart - Dual Channel
const chartADC = new Chart(document.getElementById('chartADC'), {
  type: 'line',
  data: {
    labels: [],
    datasets: [
      {
        label: 'Canal 1',
        data: [],
        borderColor: '#667eea',
        backgroundColor: 'rgba(102, 126, 234, 0.1)',
        borderWidth: 2.5,
        fill: false,
        tension: 0.1,
        pointRadius: 0,
        yAxisID: 'y'
      },
      {
        label: 'Canal 2',
        data: [],
        borderColor: '#f5576c',
        backgroundColor: 'rgba(245, 87, 108, 0.1)',
        borderWidth: 2.5,
        fill: false,
        tension: 0.1,
        pointRadius: 0,
        yAxisID: 'y1'
      }
    ]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    interaction: { mode: 'index', intersect: false },
    plugins: {
      legend: { display: true, labels: { usePointStyle: true, padding: 15 } }
    },
    scales: {
      x: {
        title: { display: true, text: 'Muestras', font: { size: 14, weight: 600 } },
        grid: { color: 'rgba(0,0,0,0.05)' }
      },
      y: {
        position: 'left',
        title: { display: true, text: 'Canal 1 (0-4095)', font: { size: 12, weight: 600, color: '#667eea' } },
        min: 0,
        max: 4095,
        grid: { color: 'rgba(102, 126, 234, 0.1)' }
      },
      y1: {
        position: 'right',
        title: { display: true, text: 'Canal 2 (0-4095)', font: { size: 12, weight: 600, color: '#f5576c' } },
        min: 0,
        max: 4095,
        grid: { drawOnChartArea: false }
      }
    }
  }
});

let latestMagnitude = NaN;
let latestPhase = NaN;

// Variables ADC
let adcBuffer = { ch1: [], ch2: [] };
let sampleCounter = 0;
let triggerArmed = false;
let triggerTriggered = false;
const MAX_ADC_SAMPLES = 500;

function parsePlot(msg) {
  const m = msg.match(/^([-+]?[0-9]*\.?[0-9]+);([0-9]*\.?[0-9]+)([AF])$/);
  if (!m) {
    log("‚ö†Ô∏è Formato inv√°lido: " + msg);
    return;
  }
  const val = parseFloat(m[1]), freq = parseFloat(m[2]), type = m[3];

  if (type === "A") {
    chartMag.data.labels.push(freq);
    chartMag.data.datasets[0].data.push(val);
    chartMag.update('none');
    latestMagnitude = Math.pow(10, val / 20);
    if (!isNaN(latestPhase)) addNyquist(latestMagnitude, latestPhase);
  } else if (type === "F") {
    chartPhase.data.labels.push(freq);
    chartPhase.data.datasets[0].data.push(val);
    chartPhase.update('none');
    latestPhase = val;
    if (!isNaN(latestMagnitude)) addNyquist(latestMagnitude, latestPhase);
  }
}

function addNyquist(mag, phase) {
  const re = mag * Math.cos(phase);
  const im = mag * Math.sin(phase);
  chartNyquist.data.datasets[0].data.push({ x: re, y: im });
  chartNyquist.update('none');
}

function downloadAllCharts() {
  const charts = [
    { chart: chartMag, name: 'magnitud.png' },
    { chart: chartPhase, name: 'fase.png' },
    { chart: chartNyquist, name: 'nyquist.png' },
    { chart: chartADC, name: 'adc.png' }
  ];
  charts.forEach(c => {
    const link = document.createElement('a');
    link.href = c.chart.toBase64Image();
    link.download = c.name;
    link.click();
  });
}

let sweepRunning = false;
let sweepAbort = false;

async function startSweep() {
  if (sweepRunning) {
    log("‚ö†Ô∏è Barrido ya en ejecuci√≥n.");
    return;
  }

  const start = parseFloat(document.getElementById("startFreq").value);
  const end = parseFloat(document.getElementById("endFreq").value);
  const step = parseFloat(document.getElementById("stepFreq").value);
  const waitSec = parseFloat(document.getElementById("waitTime").value);
  const id = document.getElementById("deviceId").value.trim();

  if (!id || isNaN(start) || isNaN(end) || isNaN(step) || isNaN(waitSec)) {
    log("‚ö†Ô∏è Complete todos los campos correctamente.");
    return;
  }

  if (end <= start || step <= 0) {
    log("‚ö†Ô∏è Valores inv√°lidos: fin debe ser > inicio y paso > 0.");
    return;
  }

  sweepRunning = true;
  sweepAbort = false;
  log(`üöÄ Iniciando barrido de ${start} Hz a ${end} Hz (paso ${step} Hz, espera ${waitSec}s)`);

  for (let f = start; f <= end; f += step) {
    if (sweepAbort) {
      log("‚èπÔ∏è Barrido detenido por usuario.");
      break;
    }
    const cmd = `S${Math.round(f)}`;
    socket.emit("send_command", { deviceId: id, command: cmd });
    log(`üì§ Enviado: ${cmd}`);
    await new Promise(res => setTimeout(res, waitSec * 1000));
  }

  sweepRunning = false;
  log("‚úÖ Barrido completado.");
}

function stopSweep() {
  if (!sweepRunning) {
    log("‚ö†Ô∏è No hay barrido en ejecuci√≥n.");
    return;
  }
  sweepAbort = true;
}

// ==========================================================
// FUNCIONES ADC - OSCILOSCOPIO
// ==========================================================
function parseADCData(data) {
  // Formato: CH1:1234,CH2:5678
  const match = data.match(/CH1:(\d+),CH2:(\d+)/);
  if (!match) return;

  const ch1 = parseInt(match[1]);
  const ch2 = parseInt(match[2]);

  adcBuffer.ch1.push(ch1);
  adcBuffer.ch2.push(ch2);
  sampleCounter++;

  // Aplicar trigger
  const triggerChannel = document.getElementById('triggerChannel').value;
  const triggerLevel = parseInt(document.getElementById('triggerLevel').value);
  const triggerMode = document.getElementById('triggerMode').value;

  let triggerValue = (triggerChannel === 'ch1') ? ch1 : (triggerChannel === 'ch2') ? ch2 : null;

  // L√≥gica de trigger
  if (triggerChannel !== 'none' && triggerValue !== null) {
    if (!triggerArmed) {
      if (triggerMode === 'rising' && triggerValue > triggerLevel) {
        triggerArmed = true;
        triggerTriggered = false;
      } else if (triggerMode === 'falling' && triggerValue < triggerLevel) {
        triggerArmed = true;
        triggerTriggered = false;
      }
    } else if (!triggerTriggered) {
      if (triggerMode === 'rising' && triggerValue <= triggerLevel) {
        triggerTriggered = true;
      } else if (triggerMode === 'falling' && triggerValue >= triggerLevel) {
        triggerTriggered = true;
      }
    }
  } else {
    triggerArmed = true;
    triggerTriggered = true;
  }

  // Actualizar gr√°fico si hay suficientes muestras o si est√° trigado
  if (adcBuffer.ch1.length >= MAX_ADC_SAMPLES && triggerTriggered) {
    updateADCChart();
    adcBuffer.ch1 = [];
    adcBuffer.ch2 = [];
    sampleCounter = 0;
    triggerArmed = false;
    triggerTriggered = false;
  }
}

function updateADCChart() {
  chartADC.data.labels = [];
  for (let i = 0; i < adcBuffer.ch1.length; i++) {
    chartADC.data.labels.push(i.toString());
  }

  chartADC.data.datasets[0].data = adcBuffer.ch1;
  chartADC.data.datasets[1].data = adcBuffer.ch2;
  chartADC.update('none');
}

function clearADCChart() {
  chartADC.data.labels = [];
  chartADC.data.datasets[0].data = [];
  chartADC.data.datasets[1].data = [];
  chartADC.update('none');
  adcBuffer.ch1 = [];
  adcBuffer.ch2 = [];
  sampleCounter = 0;
}
</script>

</body>
</html>
